<!DOCTYPE html><html><head>
      <title>Model Documentation</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\61493\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.7.9\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em!important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em!important;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em!important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px/2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      
    </head>
    <body for="html-export">
      <div class="crossnote markdown-preview  ">
      <h1 class="crossnote-header" id="models">Models</h1>

<h1 class="crossnote-header" id="action_recognition">Action_Recognition</h1>

<p><em>from your_sensor_class import SensorHandler  # Assuming the class is in a separate module</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> time
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models <span class="token keyword keyword-import">import</span>  load_model
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> madgwickahrs <span class="token keyword keyword-import">import</span> MadgwickAHRS
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
</pre><p><em>Warning: This code is not tested and is only meant to be a guide</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-class">class</span> <span class="token class-name">FeatureExtractor</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>madgwick_filter <span class="token operator">=</span> MadgwickAHRS<span class="token punctuation">(</span>sampleperiod<span class="token operator">=</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">60</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">process_batch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> gyro_readings<span class="token punctuation">,</span> accel_readings<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">attitude_roll<span class="token punctuation">,</span> attitude_pitch<span class="token punctuation">,</span> attitude_yaw <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">gravity_x<span class="token punctuation">,</span> gravity_y<span class="token punctuation">,</span> gravity_z <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">rotation_rate_x<span class="token punctuation">,</span> rotation_rate_y<span class="token punctuation">,</span> rotation_rate_z <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">user_acceleration_x<span class="token punctuation">,</span> user_acceleration_y<span class="token punctuation">,</span> user_acceleration_z <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> gyro<span class="token punctuation">,</span> accel <span class="token keyword keyword-in">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>gyro_readings<span class="token punctuation">,</span> accel_readings<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>madgwick_filter<span class="token punctuation">.</span>update_imu<span class="token punctuation">(</span>gyro<span class="token punctuation">,</span> accel<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">roll<span class="token punctuation">,</span> pitch<span class="token punctuation">,</span> yaw <span class="token operator">=</span> self<span class="token punctuation">.</span>madgwick_filter<span class="token punctuation">.</span>quaternion<span class="token punctuation">.</span>to_euler123<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">attitude_roll<span class="token punctuation">.</span>append<span class="token punctuation">(</span>roll<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">attitude_pitch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pitch<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">attitude_yaw<span class="token punctuation">.</span>append<span class="token punctuation">(</span>yaw<span class="token punctuation">)</span>
</pre><p><em>Apply a low-pass filter to isolate gravity</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">gravity <span class="token operator">=</span> low_pass_filter<span class="token punctuation">(</span>accel<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">gravity_x<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gravity<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">gravity_y<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gravity<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">gravity_z<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gravity<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><p><em>Gyro readings are the rotation rates</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">rotation_rate_x<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gyro<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">rotation_rate_y<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gyro<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">rotation_rate_z<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gyro<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><p><em>Subtract gravity to get user acceleration</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">user_acceleration <span class="token operator">=</span> accel <span class="token operator">-</span> gravity
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">user_acceleration_x<span class="token punctuation">.</span>append<span class="token punctuation">(</span>user_acceleration<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">user_acceleration_y<span class="token punctuation">.</span>append<span class="token punctuation">(</span>user_acceleration<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">user_acceleration_z<span class="token punctuation">.</span>append<span class="token punctuation">(</span>user_acceleration<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">features <span class="token operator">=</span> np<span class="token punctuation">.</span>column_stack<span class="token punctuation">(</span><span class="token punctuation">(</span>attitude_roll<span class="token punctuation">,</span> attitude_pitch<span class="token punctuation">,</span> attitude_yaw<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">gravity_x<span class="token punctuation">,</span> gravity_y<span class="token punctuation">,</span> gravity_z<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">rotation_rate_x<span class="token punctuation">,</span> rotation_rate_y<span class="token punctuation">,</span> rotation_rate_z<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">user_acceleration_x<span class="token punctuation">,</span> user_acceleration_y<span class="token punctuation">,</span> user_acceleration_z<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> features
</pre><p><em>Low-pass filter implementation</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">low_pass_filter</span><span class="token punctuation">(</span>signal<span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">gravity <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>signal<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">gravity <span class="token operator">=</span> alpha <span class="token operator">*</span> gravity <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> alpha<span class="token punctuation">)</span> <span class="token operator">*</span> signal
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> gravity
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-class">class</span> <span class="token class-name">PredictivePipeline</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model_path<span class="token operator">=</span><span class="token string">'model.h5'</span><span class="token punctuation">,</span> scaler<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model <span class="token operator">=</span> load_model<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>sensor_handler <span class="token operator">=</span> SensorHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>scaler <span class="token operator">=</span> scaler
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">grab_batch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> timewindow<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">gyro_readings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">accel_readings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-while">while</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time <span class="token operator">&lt;</span> timewindow<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">gyro<span class="token punctuation">,</span> accel <span class="token operator">=</span> self<span class="token punctuation">.</span>sensor_handler<span class="token punctuation">.</span>get_readings<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">gyro_readings<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gyro<span class="token punctuation">)</span>
</pre><p><em>Assuming gyro is a tuple (x, y, z)</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">accel_readings<span class="token punctuation">.</span>append<span class="token punctuation">(</span>accel<span class="token punctuation">)</span>
</pre><p><em>Assuming accel is a tuple (x, y, z)</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>gyro_readings<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>accel_readings<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">process_batch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">gyro_readings<span class="token punctuation">,</span> accel_readings <span class="token operator">=</span> batch
</pre><p><em>Here you would perform any feature extraction and/or transformation needed to convert the</em></p>
<p><em>gyroscope and accelerometer readings into the model-usable format.</em></p>
<p><em>For simplicity, we are just concatenating the two.</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">processed_batch <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>gyro_readings<span class="token punctuation">,</span> accel_readings<span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><p><em>Rescale using the scaler fitted during training</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>scaler<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">processed_batch <span class="token operator">=</span> self<span class="token punctuation">.</span>scaler<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>processed_batch<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> processed_batch
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">predict_batch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> processed_batch<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Assuming processed_batch is a 2D array with shape (sequence_length, number_of_features)</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">processed_batch <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>processed_batch<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">prediction <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>processed_batch<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">predicted_label <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>prediction<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> predicted_label
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> os
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> glob
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword keyword-import">import</span> MinMaxScaler
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> wandb
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> wandb<span class="token punctuation">.</span>keras <span class="token keyword keyword-import">import</span> WandbMetricsLogger<span class="token punctuation">,</span> WandbModelCheckpoint
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers <span class="token keyword keyword-import">import</span> LSTM<span class="token punctuation">,</span>Bidirectional
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> tensorflow <span class="token keyword keyword-as">as</span> tf
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> sklearn
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword keyword-import">import</span> LabelEncoder<span class="token punctuation">,</span> StandardScaler
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword keyword-import">import</span> train_test_split
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>utils <span class="token keyword keyword-import">import</span> class_weight
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models <span class="token keyword keyword-import">import</span> Sequential
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>callbacks <span class="token keyword keyword-import">import</span> EarlyStopping<span class="token punctuation">,</span> ReduceLROnPlateau
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers <span class="token keyword keyword-import">import</span> Masking<span class="token punctuation">,</span>Dense<span class="token punctuation">,</span>Dropout
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>optimizers <span class="token keyword keyword-import">import</span> Adam
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> keras
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'CUDA_VISIBLE_DEVICES'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'-1'</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Keras version:"</span><span class="token punctuation">,</span> keras<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Tensorflow version:"</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"numpy version:"</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"pandas version:"</span><span class="token punctuation">,</span> pd<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"scikit-learn version:"</span><span class="token punctuation">,</span> sklearn<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span>
</pre><p>The training below is tracked using <a href="http://wandb.ai">wandb.ai</a>, the hyperparameters and the model are tracked and can be viewed on the wandb dashboard you can choose not to use wandb by commenting out the wandb.init() and the WandbMetricsLogger and WandbModelCheckpoint callbacks</p>
<pre data-role="codeBlock" data-info="python" class="language-python python">wandb<span class="token punctuation">.</span>init<span class="token punctuation">(</span>
</pre><p><em>set the wandb project where this run will be logged</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">project<span class="token operator">=</span><span class="token string">"--"</span><span class="token punctuation">,</span>
</pre><p><em>track hyperparameters and run metadata with wandb.config</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">config<span class="token operator">=</span><span class="token punctuation">{</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"layer_1"</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"activation_1"</span><span class="token punctuation">:</span> <span class="token string">"tanh"</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"layer_2"</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"activation_2"</span><span class="token punctuation">:</span> <span class="token string">"tanh"</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"layer_3"</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"activation_3"</span><span class="token punctuation">:</span> <span class="token string">"tanh"</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"layer_3"</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"activation_3"</span><span class="token punctuation">:</span> <span class="token string">"tanh"</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"optimizer"</span><span class="token punctuation">:</span> <span class="token string">"adam"</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"layer_4"</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"activation_4"</span><span class="token punctuation">:</span> <span class="token string">"softmax"</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"loss"</span><span class="token punctuation">:</span> <span class="token string">"sparse_categorical_crossentropy"</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"metric"</span><span class="token punctuation">:</span> <span class="token string">"accuracy"</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"epoch"</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">"batch_size"</span><span class="token punctuation">:</span> <span class="token number">16</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-class">class</span> <span class="token class-name">TrainingClass</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_path<span class="token operator">=</span><span class="token string">r'E:\Test\A_DeviceMotion_data'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>data_path <span class="token operator">=</span> data_path
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model <span class="token operator">=</span> <span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>scaler <span class="token operator">=</span> <span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>X_train <span class="token operator">=</span> <span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>X_test <span class="token operator">=</span> <span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>y_train <span class="token operator">=</span> <span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>y_test <span class="token operator">=</span> <span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Num GPUs Available: "</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>config<span class="token punctuation">.</span>list_physical_devices<span class="token punctuation">(</span><span class="token string">'GPU'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Num CPUs Available: "</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>config<span class="token punctuation">.</span>list_physical_devices<span class="token punctuation">(</span><span class="token string">'CPU'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Num TPUs Available: "</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>config<span class="token punctuation">.</span>list_physical_devices<span class="token punctuation">(</span><span class="token string">'TPU'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">load_data</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">sequences <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">max_length <span class="token operator">=</span> <span class="token number">0</span>
</pre><p><em>Determine max_length without loading all data</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> folder_path <span class="token keyword keyword-in">in</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_path<span class="token punctuation">,</span> <span class="token string">'*_*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> subject_file <span class="token keyword keyword-in">in</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>folder_path<span class="token punctuation">,</span> <span class="token string">'sub_*.csv'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-with">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>subject_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">row_count <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword keyword-for">for</span> row <span class="token keyword keyword-in">in</span> <span class="token builtin">file</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">max_length <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>max_length<span class="token punctuation">,</span> row_count<span class="token punctuation">)</span>
</pre><p><em>Loop through all files in the data path and load with padding</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> folder_path <span class="token keyword keyword-in">in</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_path<span class="token punctuation">,</span> <span class="token string">'*_*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">action <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>folder_path<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> subject_file <span class="token keyword keyword-in">in</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>folder_path<span class="token punctuation">,</span> <span class="token string">'sub_*.csv'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>subject_file<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df <span class="token operator">=</span> df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><p><em>Compute statistical features</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'mean'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'std'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">.</span>std<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'min'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'max'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'UAx_lag_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'userAcceleration.x'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'UAx_diff_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'userAcceleration.x'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'UAy_lag_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'userAcceleration.y'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'UAy_diff_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'userAcceleration.y'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'UAz_lag_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'userAcceleration.z'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'UAz_diff_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'userAcceleration.z'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'UA_magnitude'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'userAcceleration.x'</span><span class="token punctuation">]</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> df<span class="token punctuation">[</span><span class="token string">'userAcceleration.y'</span><span class="token punctuation">]</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> df<span class="token punctuation">[</span><span class="token string">'userAcceleration.z'</span><span class="token punctuation">]</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Rx_lag_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'rotationRate.x'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Rx_diff_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'rotationRate.x'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Ry_lag_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'rotationRate.y'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Ry_diff_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'rotationRate.y'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Rz_lag_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'rotationRate.z'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Rz_diff_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'rotationRate.z'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'R_magnitude'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'rotationRate.x'</span><span class="token punctuation">]</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> df<span class="token punctuation">[</span><span class="token string">'rotationRate.y'</span><span class="token punctuation">]</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> df<span class="token punctuation">[</span><span class="token string">'rotationRate.z'</span><span class="token punctuation">]</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Gx_lag_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'gravity.x'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Gx_diff_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'gravity.x'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Gy_lag_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'gravity.y'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Gy_diff_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'gravity.y'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Gz_lag_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'gravity.z'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Gz_diff_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'gravity.z'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'G_magnitude'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'gravity.x'</span><span class="token punctuation">]</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> df<span class="token punctuation">[</span><span class="token string">'gravity.y'</span><span class="token punctuation">]</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> df<span class="token punctuation">[</span><span class="token string">'gravity.z'</span><span class="token punctuation">]</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Ax_lag_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'attitude.roll'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Ax_diff_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'attitude.roll'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Ay_lag_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'attitude.pitch'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Ay_diff_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'attitude.pitch'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Az_lag_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'attitude.yaw'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Az_diff_1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'attitude.yaw'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'A_magnitude'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'attitude.roll'</span><span class="token punctuation">]</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> df<span class="token punctuation">[</span><span class="token string">'attitude.pitch'</span><span class="token punctuation">]</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> df<span class="token punctuation">[</span><span class="token string">'attitude.yaw'</span><span class="token punctuation">]</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>inf<span class="token punctuation">,</span> <span class="token operator">-</span>np<span class="token punctuation">.</span>inf<span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>nan<span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><p><em>Pad the DataFrame with zeros up to max_length rows</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">padded_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token builtin">range</span><span class="token punctuation">(</span>max_length<span class="token punctuation">)</span><span class="token punctuation">,</span> columns<span class="token operator">=</span>df<span class="token punctuation">.</span>columns<span class="token punctuation">)</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">padded_df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">.</span>values
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">sequences<span class="token punctuation">.</span>append<span class="token punctuation">(</span>padded_df<span class="token punctuation">.</span>values<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">X <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>sequences<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">y <span class="token operator">=</span> LabelEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>X_train<span class="token punctuation">,</span> self<span class="token punctuation">.</span>X_test<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_train<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_test <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>X_train <span class="token operator">=</span> self<span class="token punctuation">.</span>X_train<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>X_test <span class="token operator">=</span> self<span class="token punctuation">.</span>X_test<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>X_train<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> self<span class="token punctuation">.</span>X_train<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>y_train<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_train<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>X_test<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> self<span class="token punctuation">.</span>X_test<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>y_test<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_test<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Unique labels in y_train:"</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>unique<span class="token punctuation">(</span>self<span class="token punctuation">.</span>y_train<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Unique labels in y_test:"</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>unique<span class="token punctuation">(</span>self<span class="token punctuation">.</span>y_test<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">preprocess_data</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>scaler <span class="token operator">=</span> MinMaxScaler<span class="token punctuation">(</span>feature_range<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>X_train <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> x <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>X_train<span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>X_test <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>scaler<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> x <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>X_test<span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">train_model</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Masking<span class="token punctuation">(</span>mask_value<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span> input_shape<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>X_train<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>X_train<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Bidirectional<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Bidirectional<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Bidirectional<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'tanh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'softmax'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">class_weights <span class="token operator">=</span> class_weight<span class="token punctuation">.</span>compute_class_weight<span class="token punctuation">(</span><span class="token string">'balanced'</span><span class="token punctuation">,</span>classes<span class="token operator">=</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">np<span class="token punctuation">.</span>unique<span class="token punctuation">(</span>self<span class="token punctuation">.</span>y_train<span class="token punctuation">)</span><span class="token punctuation">,</span>y<span class="token operator">=</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>y_train<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">class_weights <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">enumerate</span><span class="token punctuation">(</span>class_weights<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">optimizer <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>optimizers<span class="token punctuation">.</span>RMSprop<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss<span class="token operator">=</span><span class="token string">'sparse_categorical_crossentropy'</span><span class="token punctuation">,</span> optimizer<span class="token operator">=</span>optimizer<span class="token punctuation">,</span> metrics<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">early_stopping <span class="token operator">=</span> EarlyStopping<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">lr_decay <span class="token operator">=</span> ReduceLROnPlateau<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>X_train<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_train<span class="token punctuation">,</span> epochs<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> validation_data<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>X_test<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_test<span class="token punctuation">)</span><span class="token punctuation">,</span> callbacks<span class="token operator">=</span><span class="token punctuation">[</span>early_stopping<span class="token punctuation">,</span>lr_decay<span class="token punctuation">,</span>WandbMetricsLogger<span class="token punctuation">(</span>log_freq<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>WandbModelCheckpoint<span class="token punctuation">(</span><span class="token string">"models"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>class_weight<span class="token operator">=</span>class_weights<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">save_model</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_path<span class="token operator">=</span><span class="token string">'HARIoT.h5'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>save<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">TC <span class="token operator">=</span> TrainingClass<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">TC<span class="token punctuation">.</span>load_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">TC<span class="token punctuation">.</span>preprocess_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">TC<span class="token punctuation">.</span>train_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">TC<span class="token punctuation">.</span>save_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><h1 class="crossnote-header" id="__pycache__"><strong>pycache</strong></h1>

<h1 class="crossnote-header" id="assets">assets</h1>

<h1 class="crossnote-header" id="collision_prediction">Collision_Prediction</h1>

<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> math <span class="token keyword keyword-import">import</span> sqrt<span class="token punctuation">,</span> sin<span class="token punctuation">,</span> cos<span class="token punctuation">,</span> radians
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword keyword-as">as</span> plt
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> random
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> matplotlib<span class="token punctuation">.</span>animation <span class="token keyword keyword-import">import</span> FuncAnimation
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> math <span class="token keyword keyword-import">import</span> atan2
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> panel <span class="token keyword keyword-as">as</span> pn
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> sys
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
</pre><p>The following code is used to send the data to the Orion broker. The data is sent in the form of a JSON file. The data is sent to the topic "Orion_test/contact tracing" on the broker "<a href="http://test.mosquitto.org">test.mosquitto.org</a>" The data is sent in the json format but requires the following format:pandas dataframe Adjust the path to the Models accordingly to ensure the modules are used correctly</p>
<pre data-role="codeBlock" data-info="python" class="language-python python">sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">r'e:\\Dev\\Deakin\\redbackoperations-T2_2023\\Project 1 - Tracking Players and Crowd Monitoring\\DataScience\\Models'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">broker_address<span class="token operator">=</span><span class="token string">"test.mosquitto.org"</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">topic<span class="token operator">=</span><span class="token string">"Orion_test/collision prediction"</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> DataManager<span class="token punctuation">.</span>MQTTManager <span class="token keyword keyword-import">import</span> MQTTDataFrameHandler <span class="token keyword keyword-as">as</span> MQDH
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Handler<span class="token operator">=</span>MQDH<span class="token punctuation">(</span>broker_address<span class="token punctuation">,</span> topic<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-class">class</span> <span class="token class-name">CustomKalmanFilter</span><span class="token punctuation">:</span>
</pre><p><em>[Needs Adjustments for complex features]</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> process_variance<span class="token punctuation">,</span> measurement_variance<span class="token punctuation">,</span> initial_value<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">initial_velocity<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initial_estimate_error<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>process_variance <span class="token operator">=</span> process_variance
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>measurement_variance <span class="token operator">=</span> measurement_variance
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>estimate <span class="token operator">=</span> initial_value
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>velocity <span class="token operator">=</span> initial_velocity
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>estimate_error <span class="token operator">=</span> initial_estimate_error
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> acceleration<span class="token punctuation">,</span> direction<span class="token punctuation">,</span> dt<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">direction_rad <span class="token operator">=</span> radians<span class="token punctuation">(</span>direction<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">delta_vx <span class="token operator">=</span> acceleration <span class="token operator">*</span> cos<span class="token punctuation">(</span>direction_rad<span class="token punctuation">)</span> <span class="token operator">*</span> dt
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">delta_vy <span class="token operator">=</span> acceleration <span class="token operator">*</span> sin<span class="token punctuation">(</span>direction_rad<span class="token punctuation">)</span> <span class="token operator">*</span> dt
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>velocity <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>velocity<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> delta_vx<span class="token punctuation">,</span> self<span class="token punctuation">.</span>velocity<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> delta_vy<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>estimate <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>estimate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>velocity<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>dt <span class="token operator">+</span> <span class="token number">0.5</span><span class="token operator">*</span>delta_vx<span class="token operator">*</span>dt<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>estimate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>velocity<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>dt <span class="token operator">+</span> <span class="token number">0.5</span><span class="token operator">*</span>delta_vy<span class="token operator">*</span>dt<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>estimate_error <span class="token operator">+=</span> self<span class="token punctuation">.</span>process_variance
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> measurement<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">kalman_gain <span class="token operator">=</span> self<span class="token punctuation">.</span>estimate_error <span class="token operator">/</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>estimate_error <span class="token operator">+</span> self<span class="token punctuation">.</span>measurement_variance<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>estimate <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>estimate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> kalman_gain <span class="token operator">*</span> <span class="token punctuation">(</span>measurement<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>estimate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>estimate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> kalman_gain <span class="token operator">*</span> <span class="token punctuation">(</span>measurement<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>estimate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>estimate_error <span class="token operator">*=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> kalman_gain<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-class">class</span> <span class="token class-name">CollisionPrediction</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> process_variance<span class="token punctuation">,</span> measurement_variance<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>users <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>process_variance <span class="token operator">=</span> process_variance
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>measurement_variance <span class="token operator">=</span> measurement_variance
</pre><p><em>Store the latest collision predictions</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>latest_collisions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">update_user</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> coordinates<span class="token punctuation">,</span> speed<span class="token punctuation">,</span> direction<span class="token punctuation">,</span> acceleration<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">vx <span class="token operator">=</span> speed <span class="token operator">*</span> cos<span class="token punctuation">(</span>radians<span class="token punctuation">(</span>direction<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">vy <span class="token operator">=</span> speed <span class="token operator">*</span> sin<span class="token punctuation">(</span>radians<span class="token punctuation">(</span>direction<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> user_id <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>users<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>users<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span> <span class="token operator">=</span> CustomKalmanFilter<span class="token punctuation">(</span>self<span class="token punctuation">.</span>process_variance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>measurement_variance<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">initial_value<span class="token operator">=</span>coordinates<span class="token punctuation">,</span> initial_velocity<span class="token operator">=</span><span class="token punctuation">(</span>vx<span class="token punctuation">,</span> vy<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>users<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">.</span>predict<span class="token punctuation">(</span>acceleration<span class="token punctuation">,</span> direction<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>users<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>coordinates<span class="token punctuation">)</span>
</pre><p><em>Update the latest collision predictions each time user details are updated</em></p>
<p><em>Using a default prediction_time of 5</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>latest_collisions <span class="token operator">=</span> self<span class="token punctuation">.</span>predict_collisions<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">predict_collisions</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> prediction_time<span class="token punctuation">,</span> interval<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Predict collisions at regular intervals within the prediction time.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python">collisions <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Check for collisions at regular intervals</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> t <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> prediction_time <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">user_ids <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>users<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">future_positions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> user_id <span class="token keyword keyword-in">in</span> user_ids<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">kf <span class="token operator">=</span> self<span class="token punctuation">.</span>users<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">future_x <span class="token operator">=</span> kf<span class="token punctuation">.</span>estimate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> kf<span class="token punctuation">.</span>velocity<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>t
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">future_y <span class="token operator">=</span> kf<span class="token punctuation">.</span>estimate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> kf<span class="token punctuation">.</span>velocity<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>t
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">future_positions<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>future_x<span class="token punctuation">,</span> future_y<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>user_ids<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> j <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>user_ids<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">pos1 <span class="token operator">=</span> future_positions<span class="token punctuation">[</span>user_ids<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">pos2 <span class="token operator">=</span> future_positions<span class="token punctuation">[</span>user_ids<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">distance <span class="token operator">=</span> sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>pos1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> pos2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>pos1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> pos2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> distance <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">collisions<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token punctuation">(</span>user_ids<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> user_ids<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token builtin">list</span><span class="token punctuation">(</span>collisions<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-class">class</span> <span class="token class-name">EnhancedVisualizeMovements</span><span class="token punctuation">:</span>
</pre><p><em>[Needs Adjustments for complex features]</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> collision_prediction<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>collision_prediction <span class="token operator">=</span> collision_prediction
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">compute_distance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>point1<span class="token punctuation">,</span> point2<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>point1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> point2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>point1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> point2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">0.5</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">determine_markersize</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>distance<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token number">100</span> <span class="token operator">/</span> <span class="token punctuation">(</span>distance <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
</pre><p><em>Inverse relationship between distance and size</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">compute_intersection</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>initial_position1<span class="token punctuation">,</span> velocity1<span class="token punctuation">,</span> initial_position2<span class="token punctuation">,</span> velocity2<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Compute the intersection point of two trajectories given their initial positions and velocities.</p>
<p><em>Unpack the initial positions and velocities</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">x1<span class="token punctuation">,</span> y1 <span class="token operator">=</span> initial_position1
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">vx1<span class="token punctuation">,</span> vy1 <span class="token operator">=</span> velocity1
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> initial_position2
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">vx2<span class="token punctuation">,</span> vy2 <span class="token operator">=</span> velocity2
</pre><p><em>Handle the special cases where the trajectories are vertical</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> vx1 <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword keyword-and">and</span> vx2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
</pre><p><em>Both trajectories are vertical</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token boolean">None</span>
</pre><p><em>No unique intersection point</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-elif">elif</span> vx1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
</pre><p><em>Only the first trajectory is vertical</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">x <span class="token operator">=</span> x1
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">y <span class="token operator">=</span> vy2<span class="token operator">/</span>vx2 <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> x2<span class="token punctuation">)</span> <span class="token operator">+</span> y2
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-elif">elif</span> vx2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
</pre><p><em>Only the second trajectory is vertical</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">x <span class="token operator">=</span> x2
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">y <span class="token operator">=</span> vy1<span class="token operator">/</span>vx1 <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> x1<span class="token punctuation">)</span> <span class="token operator">+</span> y1
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
</pre><p><em>Calculate the slopes for the trajectories</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">m1 <span class="token operator">=</span> vy1 <span class="token operator">/</span> vx1
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">m2 <span class="token operator">=</span> vy2 <span class="token operator">/</span> vx2
</pre><p><em>If the slopes are equal, the trajectories are parallel and do not intersect</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> m1 <span class="token operator">==</span> m2<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token boolean">None</span>
</pre><p><em>Compute x-coordinate of intersection</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">x <span class="token operator">=</span> <span class="token punctuation">(</span>y2 <span class="token operator">-</span> y1 <span class="token operator">+</span> m1<span class="token operator">*</span>x1 <span class="token operator">-</span> m2<span class="token operator">*</span>x2<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>m1 <span class="token operator">-</span> m2<span class="token punctuation">)</span>
</pre><p><em>Compute corresponding y-coordinate using one of the trajectory equations</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">y <span class="token operator">=</span> m1 <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> x1<span class="token punctuation">)</span> <span class="token operator">+</span> y1
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">bezier_curve</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>ax<span class="token punctuation">,</span> start<span class="token punctuation">,</span> control<span class="token punctuation">,</span> end<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">t <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">curve <span class="token operator">=</span> np<span class="token punctuation">.</span>outer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span> <span class="token operator">+</span> np<span class="token punctuation">.</span>outer<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> t<span class="token punctuation">,</span> control<span class="token punctuation">)</span> <span class="token operator">+</span> np<span class="token punctuation">.</span>outer<span class="token punctuation">(</span>t<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>curve<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> curve<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">plot_enhanced_movements</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ax<span class="token punctuation">,</span> prediction_time<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Visualize user trajectories and potential collisions.</p>
<p><em>Helper function to draw a quadratic Bezier curve</em></p>
<p><em>Plot initial and predicted positions with intervals</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> user_id<span class="token punctuation">,</span> kf <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>collision_prediction<span class="token punctuation">.</span>users<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">color <span class="token operator">=</span> user_colors<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span>
</pre><p><em>Use predefined colors for consistency</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">initial_x<span class="token punctuation">,</span> initial_y <span class="token operator">=</span> kf<span class="token punctuation">.</span>estimate
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> t <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> prediction_time <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Recompute direction at each step</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">dx <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">dy <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">predicted_x <span class="token operator">=</span> initial_x <span class="token operator">+</span> dx <span class="token operator">*</span> prediction_time
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">predicted_y <span class="token operator">=</span> initial_y <span class="token operator">+</span> dy <span class="token operator">*</span> prediction_time
</pre><p><em>Use velocities (if available) or midpoints to determine control point</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">control_x <span class="token operator">=</span> initial_x <span class="token operator">+</span> dx <span class="token operator">/</span> <span class="token number">2</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">control_y <span class="token operator">=</span> initial_y <span class="token operator">+</span> dy <span class="token operator">/</span> <span class="token number">2</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>bezier_curve<span class="token punctuation">(</span>ax<span class="token punctuation">,</span> <span class="token punctuation">(</span>initial_x<span class="token punctuation">,</span> initial_y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>control_x<span class="token punctuation">,</span> control_y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>predicted_x<span class="token punctuation">,</span> predicted_y<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token operator">=</span>color<span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>initial_x<span class="token punctuation">,</span> initial_y<span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">,</span> color<span class="token operator">=</span>color<span class="token punctuation">,</span> markersize<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span><span class="token string">'Start'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>initial_x<span class="token punctuation">,</span> initial_y<span class="token punctuation">)</span><span class="token punctuation">,</span> textcoords<span class="token operator">=</span><span class="token string">"offset points"</span><span class="token punctuation">,</span> xytext<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ha<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>predicted_x<span class="token punctuation">,</span> predicted_y<span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> color<span class="token operator">=</span>color<span class="token punctuation">,</span> markersize<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span><span class="token string">'End'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>predicted_x<span class="token punctuation">,</span> predicted_y<span class="token punctuation">)</span><span class="token punctuation">,</span> textcoords<span class="token operator">=</span><span class="token string">"offset points"</span><span class="token punctuation">,</span> xytext<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ha<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">collisions <span class="token operator">=</span> self<span class="token punctuation">.</span>collision_prediction<span class="token punctuation">.</span>predict_collisions<span class="token punctuation">(</span>prediction_time<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> user1<span class="token punctuation">,</span> user2 <span class="token keyword keyword-in">in</span> collisions<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">future_position1 <span class="token operator">=</span> self<span class="token punctuation">.</span>collision_prediction<span class="token punctuation">.</span>users<span class="token punctuation">[</span>user1<span class="token punctuation">]</span><span class="token punctuation">.</span>estimate
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">velocity1 <span class="token operator">=</span> self<span class="token punctuation">.</span>collision_prediction<span class="token punctuation">.</span>users<span class="token punctuation">[</span>user1<span class="token punctuation">]</span><span class="token punctuation">.</span>velocity
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">future_position2 <span class="token operator">=</span> self<span class="token punctuation">.</span>collision_prediction<span class="token punctuation">.</span>users<span class="token punctuation">[</span>user2<span class="token punctuation">]</span><span class="token punctuation">.</span>estimate
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">velocity2 <span class="token operator">=</span> self<span class="token punctuation">.</span>collision_prediction<span class="token punctuation">.</span>users<span class="token punctuation">[</span>user2<span class="token punctuation">]</span><span class="token punctuation">.</span>velocity
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">collision_point <span class="token operator">=</span> self<span class="token punctuation">.</span>compute_intersection<span class="token punctuation">(</span>future_position1<span class="token punctuation">,</span> velocity1<span class="token punctuation">,</span> future_position2<span class="token punctuation">,</span> velocity2<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> collision_point<span class="token punctuation">:</span>
</pre><p><em>If there's a unique intersection point plot it</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">collision_x<span class="token punctuation">,</span> collision_y <span class="token operator">=</span> collision_point
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">distance <span class="token operator">=</span> self<span class="token punctuation">.</span>compute_distance<span class="token punctuation">(</span><span class="token punctuation">(</span>future_position1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> velocity1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> prediction_time<span class="token punctuation">,</span> future_position1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> velocity1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> prediction_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span>future_position2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> velocity2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> prediction_time<span class="token punctuation">,</span> future_position2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> velocity2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> prediction_time<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">size <span class="token operator">=</span> self<span class="token punctuation">.</span>determine_markersize<span class="token punctuation">(</span>distance<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>collision_x<span class="token punctuation">,</span> collision_y<span class="token punctuation">,</span> <span class="token string">'ro'</span><span class="token punctuation">,</span> markersize<span class="token operator">=</span>size<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'user1'</span><span class="token punctuation">:</span>user1<span class="token punctuation">,</span><span class="token string">'user2'</span><span class="token punctuation">:</span>user2<span class="token punctuation">,</span><span class="token string">'collision_point'</span><span class="token punctuation">:</span>collision_point<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token operator">=</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> df <span class="token keyword keyword-is">is</span> <span class="token keyword keyword-not">not</span> <span class="token boolean">None</span> <span class="token keyword keyword-or">or</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Handler<span class="token punctuation">.</span>send_data<span class="token punctuation">(</span>df<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Data Sent to Orion:"</span><span class="token punctuation">,</span> df<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-except">except</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Error Sending Data to Orion, current data:"</span><span class="token punctuation">,</span>df<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-continue">continue</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"User Movements: Initial to </span><span class="token interpolation"><span class="token punctuation">{</span>prediction_time<span class="token punctuation">}</span></span><span class="token string"> Time Units"</span></span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">"X Coordinate"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">"Y Coordinate"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">"upper right"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em># Send Collision Data to Orion Broker</em></p>
<p><em>Testing the User class with natural movement</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">NUM_USERS <span class="token operator">=</span> <span class="token number">10</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">NUM_ITERATIONS <span class="token operator">=</span> <span class="token number">100</span>
</pre><p><em>Initialize the collision prediction system and visualizer</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">collision_prediction <span class="token operator">=</span> CollisionPrediction<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">visualizer <span class="token operator">=</span> EnhancedVisualizeMovements<span class="token punctuation">(</span>collision_prediction<span class="token punctuation">)</span>
</pre><p><em>Create the initial plot</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">fig<span class="token punctuation">,</span> ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>set_xlim<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>set_ylim<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"User Movements Animation"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">"X Coordinate"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">"Y Coordinate"</span><span class="token punctuation">)</span>
</pre><p><em>Initialize user_positions dictionary outside the update function to persist positions across frames</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">user_positions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">adjusted_color_map</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> total<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Adjust the index to skip the red portion of the jet colormap</em></p>
<p><em>This can be fine-tuned based on the exact portion of the colormap you want to exclude</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> index <span class="token operator">/</span> total <span class="token operator">&gt;</span> <span class="token number">0.7</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">index <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0.2</span> <span class="token operator">*</span> total<span class="token punctuation">)</span>
</pre><p><em>skip 20% of the colormap after the 70% mark</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>jet<span class="token punctuation">(</span>index <span class="token operator">/</span> total<span class="token punctuation">)</span>
</pre><p><em>Assigning a fixed color to each user to ensure consistent coloring across frames</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">user_colors <span class="token operator">=</span> <span class="token punctuation">{</span>user_id<span class="token punctuation">:</span> adjusted_color_map<span class="token punctuation">(</span>i<span class="token punctuation">,</span> NUM_USERS<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> user_id <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> NUM_USERS <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">update</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>set_xlim<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</pre><p><em>Adjusting limits to match the earlier defined space</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>set_ylim<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> user_id <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> NUM_USERS <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Check the current position of the user</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">current_position <span class="token operator">=</span> user_positions<span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> <span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p><em>Generate incremental movement parameters</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">dx <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">dy <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">x <span class="token operator">=</span> current_position<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> dx
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">y <span class="token operator">=</span> current_position<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> dy
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">user_positions<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
</pre><p><em>Update the new position in the dictionary</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">speed <span class="token operator">=</span> <span class="token punctuation">(</span>dx<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> dy<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">0.5</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">direction <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">180</span> <span class="token operator">/</span> <span class="token number">3.14159</span><span class="token punctuation">)</span> <span class="token operator">*</span> atan2<span class="token punctuation">(</span>dy<span class="token punctuation">,</span> dx<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">direction <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">180</span> <span class="token operator">/</span> <span class="token number">3.14159</span><span class="token punctuation">)</span> <span class="token operator">*</span> atan2<span class="token punctuation">(</span>dy<span class="token punctuation">,</span> dx<span class="token punctuation">)</span>
</pre><p><em>Introduce a random direction shift</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">angle_shift <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span>
</pre><p><em>Random shift between -30 and 30 degrees</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">direction <span class="token operator">+=</span> angle_shift
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">acceleration <span class="token operator">=</span> <span class="token number">0</span>
</pre><p><em>Assuming no acceleration for simplicity</em></p>
<p><em>Update user's movement in the collision prediction system</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">collision_prediction<span class="token punctuation">.</span>update_user<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> speed<span class="token punctuation">,</span> direction<span class="token punctuation">,</span> acceleration<span class="token punctuation">)</span>
</pre><p><em>Plot the user's position with a fixed color</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">ax<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> color<span class="token operator">=</span>user_colors<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"User </span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</pre><p><em>Visualize the movements and potential collisions</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">visualizer<span class="token punctuation">.</span>plot_enhanced_movements<span class="token punctuation">(</span>ax<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plot_panel <span class="token operator">=</span> pn<span class="token punctuation">.</span>pane<span class="token punctuation">.</span>Matplotlib<span class="token punctuation">(</span>fig<span class="token punctuation">,</span> tight<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><p><em>Create a Panel pane from the Matplotlib figure</em></p>
<p><em>Create the animation</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">ani <span class="token operator">=</span> FuncAnimation<span class="token punctuation">(</span>fig<span class="token punctuation">,</span> update<span class="token punctuation">,</span> frames<span class="token operator">=</span><span class="token builtin">range</span><span class="token punctuation">(</span>NUM_ITERATIONS<span class="token punctuation">)</span><span class="token punctuation">,</span> repeat<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Empty to allow this folder to be treated as a package and allow communication between files</em></p>
<h1 class="crossnote-header" id="__pycache__-1"><strong>pycache</strong></h1>

<h1 class="crossnote-header" id="contact_tracing">Contact_Tracing</h1>

<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> datetime <span class="token keyword keyword-import">import</span> datetime<span class="token punctuation">,</span>timedelta
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword keyword-as">as</span> plt
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> json
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> sys
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> panel <span class="token keyword keyword-as">as</span> pn
</pre><p>The following code before the class is used to send the data to the Orion broker. The data is sent in the form of a JSON file. The data is sent to the topic "Orion_test/contact tracing" on the broker "<a href="http://test.mosquitto.org">test.mosquitto.org</a>" The data is sent in the json format but requires the following format:pandas dataframe Adjust the path to the Models accordingly to ensure the modules are used correctly</p>
<pre data-role="codeBlock" data-info="python" class="language-python python">sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">r'e:\\Dev\\Deakin\\redbackoperations-T2_2023\\Project 1 - Tracking Players and Crowd Monitoring\\DataScience\\Models'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">broker_address<span class="token operator">=</span><span class="token string">"test.mosquitto.org"</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">topic<span class="token operator">=</span><span class="token string">"Orion_test/contact tracing"</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> DataManager<span class="token punctuation">.</span>MQTTManager <span class="token keyword keyword-import">import</span> MQTTDataFrameHandler <span class="token keyword keyword-as">as</span> MQDH
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Handler<span class="token operator">=</span>MQDH<span class="token punctuation">(</span>broker_address<span class="token punctuation">,</span> topic<span class="token punctuation">)</span>
</pre><p>The class below is used for contact tracing it requires the following inputs: UserID: The user ID of the user Coordinates: The coordinates of the user Timestamp: The timestamp of the user at the coordinates  The class has the following functions: add_record: Adds a new record to the dataframe get_time_based_contacts: Gets the contacts of the user based on the time window and radius   It can be extended to include more functions as required for example a function to get the contacts of the user based on the location or a neural network to predict the contacts of the user based on the location and time</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-class">class</span> <span class="token class-name">ContactTracer</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"UserID"</span><span class="token punctuation">,</span> <span class="token string">"Coordinates"</span><span class="token punctuation">,</span> <span class="token string">"Timestamp"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">add_record</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> coordinates<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Add a new location record for a user using pandas.concat.""" if timestamp is None: timestamp = datetime.now() new_record = pd.DataFrame({"UserID": [user_id], "Coordinates": [coordinates], "Timestamp": [timestamp]}) self.data = pd.concat([self.data, new_record], ignore_index=True)  def get_time_based_contacts(self, user_id, radius, time_window=timedelta(minutes=30)):</p>
<pre data-role="codeBlock" data-info="python" class="language-python python">user_data <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">"UserID"</span><span class="token punctuation">]</span> <span class="token operator">==</span> user_id<span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">potential_contacts <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> _<span class="token punctuation">,</span> record <span class="token keyword keyword-in">in</span> user_data<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">lat1<span class="token punctuation">,</span> lon1 <span class="token operator">=</span> record<span class="token punctuation">[</span><span class="token string">"Coordinates"</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">timestamp <span class="token operator">=</span> record<span class="token punctuation">[</span><span class="token string">"Timestamp"</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">contacts <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">"Timestamp"</span><span class="token punctuation">]</span> <span class="token operator">-</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> time_window
</pre><p><em>time condition</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> _<span class="token punctuation">,</span> contact <span class="token keyword keyword-in">in</span> contacts<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">lat2<span class="token punctuation">,</span> lon2 <span class="token operator">=</span> contact<span class="token punctuation">[</span><span class="token string">"Coordinates"</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">distance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lat1 <span class="token operator">-</span> lat2<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>lon1 <span class="token operator">-</span> lon2<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">0.5</span>
</pre><p><em>simple distance formula</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> distance <span class="token operator">&lt;=</span> radius <span class="token keyword keyword-and">and</span> contact<span class="token punctuation">[</span><span class="token string">"UserID"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> user_id<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">potential_contacts <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>potential_contacts<span class="token punctuation">,</span> contact<span class="token punctuation">.</span>to_frame<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span> ignore_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><p><em>Drop duplicate rows</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">potential_contacts <span class="token operator">=</span> potential_contacts<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> potential_contacts
</pre><p><em>Re-populate the ContactTracer instance with the previously generated data (with timestamps)</em></p>
<p><em>Repopulating the ContactTracer instance with the provided data and adding timestamps</em></p>
<p><em>Resetting the ContactTracer instance</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">tracer <span class="token operator">=</span> ContactTracer<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Adding records with timestamps</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">records <span class="token operator">=</span> <span class="token punctuation">[</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserA"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserB"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserC"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserA"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserA"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserA"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserD"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserD"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserD"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserD"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserD"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserD"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserD"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserE"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span><span class="token string">"UserE"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">]</span>
</pre><p><em>Assigning a unique timestamp for each record</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">base_timestamp <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>user<span class="token punctuation">,</span> coords<span class="token punctuation">)</span> <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">timestamp <span class="token operator">=</span> base_timestamp <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span>i<span class="token punctuation">)</span>
</pre><p><em>Each record is 1 minute apart</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">tracer<span class="token punctuation">.</span>add_record<span class="token punctuation">(</span>user<span class="token punctuation">,</span> coords<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span>
</pre><p><em>getting all user contacts to send to the Orion broker</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> user <span class="token keyword keyword-in">in</span> tracer<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">"UserID"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">contacts <span class="token operator">=</span> tracer<span class="token punctuation">.</span>get_time_based_contacts<span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Contacts of </span><span class="token interpolation"><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span><span class="token string">:"</span></span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>contacts<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token operator">=</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>contacts<span class="token punctuation">)</span>
</pre><p><em>Handler.send_data(df, user_id=user)#uncomment to send data to the broker</em></p>
<p><em>Getting contacts of UserA within a radius of 2 units</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">contacts <span class="token operator">=</span> tracer<span class="token punctuation">.</span>get_time_based_contacts<span class="token punctuation">(</span><span class="token string">"UserA"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">plot_spatial_temporal_contacts</span><span class="token punctuation">(</span>central_user<span class="token punctuation">,</span> contacts_df<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">figure<span class="token operator">=</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p><em>Plot the central user at (0,0) for simplicity</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span> label<span class="token operator">=</span>central_user<span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> zorder<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> central_user<span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> ha<span class="token operator">=</span><span class="token string">'right'</span><span class="token punctuation">)</span>
</pre><p><em>Plot the contacts</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">colors <span class="token operator">=</span> plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>rainbow<span class="token punctuation">(</span>np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>contacts_df<span class="token punctuation">[</span><span class="token string">"UserID"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">color_map <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>contacts_df<span class="token punctuation">[</span><span class="token string">"UserID"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> colors<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> _<span class="token punctuation">,</span> row <span class="token keyword keyword-in">in</span> contacts_df<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">x<span class="token punctuation">,</span> y <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token string">"Coordinates"</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">user <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token string">"UserID"</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> color<span class="token operator">=</span>color_map<span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>text<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> user<span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> ha<span class="token operator">=</span><span class="token string">'right'</span><span class="token punctuation">)</span>
</pre><p><em>Draw a line between the central user and the contact</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span>color_map<span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><p><em>Annotate the line with the timestamp of contact</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">midpoint <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>y<span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">"Timestamp"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%H:%M:%S'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">xy<span class="token operator">=</span>midpoint<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">xytext<span class="token operator">=</span>midpoint<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">fontsize<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">arrowprops<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>facecolor<span class="token operator">=</span><span class="token string">'black'</span><span class="token punctuation">,</span> arrowstyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ha<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"Longitude"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"Latitude"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Spatial-Temporal Contacts of </span><span class="token interpolation"><span class="token punctuation">{</span>central_user<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> figure
</pre><p><em>Plotting the contacts of "UserA"</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">fig<span class="token operator">=</span>plot_spatial_temporal_contacts<span class="token punctuation">(</span><span class="token string">"UserA"</span><span class="token punctuation">,</span> contacts<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>close<span class="token punctuation">(</span>fig<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plot_panel <span class="token operator">=</span> pn<span class="token punctuation">.</span>pane<span class="token punctuation">.</span>Matplotlib<span class="token punctuation">(</span>fig<span class="token punctuation">,</span> tight<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><p><em>Empty to allow this folder to be treated as a package and allow communication between files</em></p>
<h1 class="crossnote-header" id="__pycache__-2"><strong>pycache</strong></h1>

<h1 class="crossnote-header" id="dashboard">Dashboard</h1>

<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> panel <span class="token keyword keyword-as">as</span> pn
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> os
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> sys
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword keyword-as">as</span> plt
</pre><p>This is the Dashboard class that will be used to create the dashboard. It has the following functions: add_plot: Adds a plot to the dashboard add_widget: Adds a widget to the dashboard add_detail: Adds a detail to the dashboard construct_dashboard: Constructs the dashboard show: Displays the dashboard   The dashboard class can be used in conjuction with other modules to create a dashboard. For example, the dashboard can be used with the MQTTManager to display the data received from the MQTT broker. The dashboard can also be used with the ContactTracer to display the contacts of the user based on the time and location</p>
<pre data-role="codeBlock" data-info="python" class="language-python python">sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">r'e:\\Dev\\Deakin\\redbackoperations-T2_2023\\Project 1 - Tracking Players and Crowd Monitoring\\DataScience\\Models'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> Collision_Prediction <span class="token keyword keyword-import">import</span> Co_Pred
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> Contact_Tracing <span class="token keyword keyword-import">import</span> Tracer
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> HeartRate_Monitoring <span class="token keyword keyword-import">import</span> HeartRateMonitor
</pre><p><em>from Individual_Tracking import Tracker_run</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> Overcrowding_Detection <span class="token keyword keyword-import">import</span> ODHG
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Collision_Panel <span class="token operator">=</span> Co_Pred<span class="token punctuation">.</span>plot_panel
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Contact_Panel <span class="token operator">=</span> Tracer<span class="token punctuation">.</span>plot_panel
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">HeartRate_Panel <span class="token operator">=</span> HeartRateMonitor<span class="token punctuation">.</span>plot_panel
</pre><p><em>Individual_Panel = Tracker_run.plot_panel()</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">Overcrowding_Panel <span class="token operator">=</span> ODHG<span class="token punctuation">.</span>plot_panel
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-class">class</span> <span class="token class-name">Dashboard</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> plots<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> widgets<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> details<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>plots <span class="token operator">=</span> plots <span class="token keyword keyword-if">if</span> plots <span class="token keyword keyword-else">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>widgets <span class="token operator">=</span> widgets <span class="token keyword keyword-if">if</span> widgets <span class="token keyword keyword-else">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>details <span class="token operator">=</span> details <span class="token keyword keyword-if">if</span> details <span class="token keyword keyword-else">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">save_plot_as_image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> plot<span class="token punctuation">,</span> img_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Save the provided Matplotlib figure or Panel Matplotlib pane as an image and return a PNG pane.""" # Check if the plot is a Panel Matplotlib pane and extract the figure if so if isinstance(plot, pn.pane.Matplotlib): fig = plot.object elif isinstance(plot, plt.Axes):  # Check if it's an AxesSubplot object fig = plot.figure else: fig = plot  # Assuming you save images in an 'images' directory images=r'E:\Dev\Deakin\redbackoperations-T2_2023\Project 1 - Tracking Players and Crowd Monitoring\DataScience\Models\Dashboard\images' images_dir = os.path.join(images, img_name) fig.savefig(images_dir) image_pane = pn.pane.PNG(images_dir, width=500) return image_pane def add_plot(self, fig, img_name):</p>
<pre data-role="codeBlock" data-info="python" class="language-python python">image_pane <span class="token operator">=</span> self<span class="token punctuation">.</span>save_plot_as_image<span class="token punctuation">(</span>fig<span class="token punctuation">,</span> img_name<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>plots<span class="token punctuation">.</span>append<span class="token punctuation">(</span>image_pane<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">add_gif_to_dashboard</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> gif_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Add a GIF to the Panel dashboard.  Parameters: - gif_path (str): Path to the GIF file.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python">gif_pane <span class="token operator">=</span> pn<span class="token punctuation">.</span>pane<span class="token punctuation">.</span>Image<span class="token punctuation">(</span>gif_path<span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>plots<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gif_pane<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">add_widget</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> widget<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Add a widget to the dashboard.""" if widget: self.widgets.append(widget)  def add_detail(self, detail):</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> detail<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>details<span class="token punctuation">.</span>append<span class="token punctuation">(</span>detail<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">construct_dashboard</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Construct and return the dashboard layout by interleaving plots and details.""" items = []  # Adding widgets if any if self.widgets: items.append(pn.Row(*self.widgets))  # Interleave plots and details for plot, detail in zip(self.plots, self.details): items.append(plot) items.append(detail)  # If there are any remaining plots or details, add them as well remaining_plots = len(self.plots) - len(self.details) for i in range(remaining_plots): items.append(self.plots[len(self.details) + i])  remaining_details = len(self.details) - len(self.plots) for i in range(remaining_details): items.append(self.details[len(self.plots) + i])  dashboard = pn.Column(*items) return dashboard  def show(self):</p>
<pre data-role="codeBlock" data-info="python" class="language-python python">dashboard <span class="token operator">=</span> self<span class="token punctuation">.</span>construct_dashboard<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">dashboard<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Create the Dashboard instance and add plots</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">dashboard_instance <span class="token operator">=</span> Dashboard<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">dashboard_instance<span class="token punctuation">.</span>add_gif_to_dashboard<span class="token punctuation">(</span><span class="token string">r'E:\Dev\Deakin\redbackoperations-T2_2023\Project 1 - Tracking Players and Crowd Monitoring\DataScience\Models\Dashboard\images\Collision_P.gif'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">coll_deets<span class="token operator">=</span><span class="token string">'The above plot provides insights into potential collisions among tracked users over a specified timeframe. Each colored line represents the predicted trajectory of a different user, with the starting point marked as -Start- and the predicted endpoint as -End-. The presence of a red circle indicates a predicted point of collision. The size of the circle is proportional to the likelihood of a collision, with larger circles signifying higher probabilities. Such predictions can be instrumental in ensuring user safety by preempting and averting possible collisions.'</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">dashboard_instance<span class="token punctuation">.</span>add_detail<span class="token punctuation">(</span>coll_deets<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">dashboard_instance<span class="token punctuation">.</span>add_plot<span class="token punctuation">(</span>Tracer<span class="token punctuation">.</span>plot_panel<span class="token punctuation">,</span> <span class="token string">"Contact_Tracing.png"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">cont_deets<span class="token operator">=</span><span class="token string">'The plot above is a visual representation of user contacts based on temporal and spatial data. It traces the interactions between different users, highlighting moments of close proximity. Such visualizations are crucial, especially in scenarios like infectious disease outbreaks, where understanding person-to-person contact patterns can play a pivotal role in containment and mitigation strategies.'</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">dashboard_instance<span class="token punctuation">.</span>add_detail<span class="token punctuation">(</span>cont_deets<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">dashboard_instance<span class="token punctuation">.</span>add_plot<span class="token punctuation">(</span>HeartRateMonitor<span class="token punctuation">.</span>plot_panel<span class="token punctuation">,</span> <span class="token string">"HeartRate_Monitoring.png"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">HR_deets<span class="token operator">=</span><span class="token string">'The displayed plot captures the heart rate data of users over time, providing a continuous monitor of their cardiovascular health. Fluctuations, spikes, or irregular patterns can be indicative of underlying health conditions or moments of heightened stress or activity. Regular monitoring can aid in timely interventions and ensure the well-being of users.'</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">dashboard_instance<span class="token punctuation">.</span>add_detail<span class="token punctuation">(</span>HR_deets<span class="token punctuation">)</span>
</pre><p><em>dashboard_instance.add_plot(Tracker_run.plot_panel)</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">dashboard_instance<span class="token punctuation">.</span>add_plot<span class="token punctuation">(</span>ODHG<span class="token punctuation">.</span>plot_panel<span class="token punctuation">,</span> <span class="token string">"Overcrowding_Detection.png"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">dashboard_instance<span class="token punctuation">.</span>add_plot<span class="token punctuation">(</span>ODHG<span class="token punctuation">.</span>plot_panel2<span class="token punctuation">,</span> <span class="token string">"Overcrowding_Detection2.png"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">OD_deets<span class="token operator">=</span><span class="token string">'The presented visualizations delve into crowd density estimation within a specified area. The first plot delineates clusters, showcasing the congregation of individuals in specific zones. The subsequent heatmap offers a gradient view of crowd density, with warmer colors signifying areas of higher congestion. Such depictions are invaluable in scenarios that demand crowd management, ensuring safety protocols, and optimizing space utilization.'</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">dashboard_instance<span class="token punctuation">.</span>add_detail<span class="token punctuation">(</span>OD_deets<span class="token punctuation">)</span>
</pre><p><em>Construct and save the dashboard</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">constructed_dashboard <span class="token operator">=</span> dashboard_instance<span class="token punctuation">.</span>construct_dashboard<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">constructed_dashboard<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">r'E:\Dev\Deakin\redbackoperations-T2_2023\Project 1 - Tracking Players and Crowd Monitoring\DataScience\Models\Dashboard\dashboard.html'</span><span class="token punctuation">)</span>
</pre><h1 class="crossnote-header" id="images">images</h1>

<h1 class="crossnote-header" id="__pycache__-3"><strong>pycache</strong></h1>

<h1 class="crossnote-header" id="datamanager">DataManager</h1>

<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> paho<span class="token punctuation">.</span>mqtt<span class="token punctuation">.</span>client <span class="token keyword keyword-as">as</span> mqtt
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> json
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> time
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> ssl
</pre><p><em>Importing ssl certificates - ensures data transmitted is encrypted</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> datetime
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> datetime <span class="token keyword keyword-import">import</span> datetime
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> cryptography<span class="token punctuation">.</span>fernet <span class="token keyword keyword-import">import</span> Fernet
</pre><p><em>importing cryptogtaphy library</em></p>
<p>The class below is used to send and receive data from the MQTT broker. The data is sent in the form of a JSON file. The data is sent to the topic "test/topic" on the broker "<a href="http://test.mosquitto.org">test.mosquitto.org</a>"/any other broker</p>
<p><em>adding an encryption and decryption key</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">encryption_key <span class="token operator">=</span> Fernet<span class="token punctuation">.</span>generate_key<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">cipher_suite <span class="token operator">=</span> Fernet<span class="token punctuation">(</span>encryption_key<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-class">class</span> <span class="token class-name">MQTTDataFrameHandler</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> broker_address<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> max_retries<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> retry_interval<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>broker_address <span class="token operator">=</span> broker_address
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>topic <span class="token operator">=</span> topic
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>client <span class="token operator">=</span> mqtt<span class="token punctuation">.</span>Client<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>on_message <span class="token operator">=</span> self<span class="token punctuation">.</span>_on_message
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>max_retries <span class="token operator">=</span> max_retries
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>retry_interval <span class="token operator">=</span> retry_interval
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">_on_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> client<span class="token punctuation">,</span> userdata<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
</pre><p><em>Convert received message payload to DataFrame</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">encrypted_data <span class="token operator">=</span> message<span class="token punctuation">.</span>payload
</pre><p><em>decrypt and convert received message</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">data_json <span class="token operator">=</span> cipher_suite<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>encrypted_data<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
</pre><p><em>uses key to decrypt data</em></p>
<p><em>Convert received message payload to DataFrame</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">data_json <span class="token operator">=</span> message<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_json<span class="token punctuation">(</span>data_json<span class="token punctuation">)</span>
</pre><p><em>Add a timestamp column to the DataFrame to allow tracking of data age</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'timestamp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">create_json_payload</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dataframe<span class="token punctuation">,</span> user_id<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Convert dataframe to JSON format</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">data_json <span class="token operator">=</span> dataframe<span class="token punctuation">.</span>to_json<span class="token punctuation">(</span>orient<span class="token operator">=</span><span class="token string">'split'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">payload <span class="token operator">=</span> <span class="token punctuation">{</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">'timestamp'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">'data'</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data_json<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> user_id<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">payload<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_id
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">receive_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">retries <span class="token operator">=</span> <span class="token number">0</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-while">while</span> retries <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>max_retries<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>broker_address<span class="token punctuation">,</span> <span class="token number">1883</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>subscribe<span class="token punctuation">(</span>self<span class="token punctuation">.</span>topic<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>loop_start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-while">while</span> self<span class="token punctuation">.</span>data <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span> <span class="token keyword keyword-and">and</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">&lt;</span> timeout<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>error<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error while receiving data: </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>error<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-break">break</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>loop_stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>data
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Connection error: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">. Retrying in </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>retry_interval<span class="token punctuation">}</span></span><span class="token string"> seconds..."</span></span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">retries <span class="token operator">+=</span> <span class="token number">1</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>self<span class="token punctuation">.</span>retry_interval<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Max retries reached. Failed to receive data."</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">send_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> df <span class="token punctuation">,</span> user_id<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">retries <span class="token operator">=</span> <span class="token number">0</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-while">while</span> retries <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>max_retries<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">json_payload <span class="token operator">=</span> self<span class="token punctuation">.</span>create_json_payload<span class="token punctuation">(</span>df<span class="token punctuation">,</span>user_id<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>broker_address<span class="token punctuation">,</span> <span class="token number">1883</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>publish<span class="token punctuation">(</span>self<span class="token punctuation">.</span>topic<span class="token punctuation">,</span> json_payload<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>disconnect<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error while sending data: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">. Retrying in </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>retry_interval<span class="token punctuation">}</span></span><span class="token string"> seconds..."</span></span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">retries <span class="token operator">+=</span> <span class="token number">1</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>self<span class="token punctuation">.</span>retry_interval<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Max retries reached. Failed to send data."</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>placeholders</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">broker_address <span class="token operator">=</span> <span class="token string">"test.mosquitto.org"</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">topic <span class="token operator">=</span> <span class="token string">"test/topic"</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">handler <span class="token operator">=</span> MQTTDataFrameHandler<span class="token punctuation">(</span>broker_address<span class="token punctuation">,</span> topic<span class="token punctuation">)</span>
</pre><p><em>SSL setup for client</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">handler<span class="token punctuation">.</span>client<span class="token punctuation">.</span>tls_set<span class="token punctuation">(</span>ca_certs<span class="token operator">=</span><span class="token string">"ca.crt"</span><span class="token punctuation">,</span> certfile<span class="token operator">=</span><span class="token string">"client.crt"</span><span class="token punctuation">,</span> keyfile<span class="token operator">=</span><span class="token string">"client.key"</span><span class="token punctuation">,</span> tls_version<span class="token operator">=</span>ssl<span class="token punctuation">.</span>PROTOCOL_TLS<span class="token punctuation">)</span>
</pre><p><em>Path should be rewritten to find actual files</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">handler<span class="token punctuation">.</span>client<span class="token punctuation">.</span>username_pw_set<span class="token punctuation">(</span><span class="token string">"client_username"</span><span class="token punctuation">,</span> <span class="token string">"client_password"</span><span class="token punctuation">)</span>
</pre><p><em>'client_username' and 'cliet_password' should be replaced with client's actual username and password</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> flask <span class="token keyword keyword-import">import</span> Flask<span class="token punctuation">,</span> request
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/receive_data'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">receive_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data <span class="token operator">=</span> request<span class="token punctuation">.</span>json
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">handler <span class="token operator">=</span> DataHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">handler<span class="token punctuation">.</span>save_data<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"data saved"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token string">"Data received"</span><span class="token punctuation">,</span> <span class="token number">200</span>
</pre><p>The class below is used in conjuction with the provided unity virtual environment  to recieve virtual data in realtime to simulate a live service. The data recieved is in a static format so any changes made here should be reflected in the code within unity  This class act as a server to recieve the data, this data can then be used to populate the database and evaluate the models/modules, this data can also be used to populate the dashboard  The data is completely random and is not based on any real world data and also with every run the unity environment creates a new set of data but the format remains the same, the current setting is San Francisco, USA for gps data</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> sqlite3
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-class">class</span> <span class="token class-name">DataHandler</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'data.db'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>create_table<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">create_table</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-with">with</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">''</span>'
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">CREATE TABLE IF NOT EXISTS user_data <span class="token punctuation">(</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Time TEXT<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Agent_ID TEXT<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Device_Type TEXT<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Accelerometer_X TEXT<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Accelerometer_Y TEXT<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Accelerometer_Z TEXT<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Gyroscope_X TEXT<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Gyroscope_Y TEXT<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Gyroscope_Z TEXT<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Longitude_Degrees TEXT<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Longitude_Minutes TEXT<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Latitude_Degrees TEXT<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Latitude_Minutes TEXT<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Altitude TEXT
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">)</span>
</pre><p>)  def save_data(self, data): with self.conn: self.conn.execute(''' INSERT INTO user_data ( Time, Agent_ID, Device_Type, Accelerometer_X, Accelerometer_Y, Accelerometer_Z, Gyroscope_X, Gyroscope_Y, Gyroscope_Z, Longitude_Degrees, Longitude_Minutes, Latitude_Degrees, Latitude_Minutes, Altitude ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)</p>
<pre data-role="codeBlock" data-info="python" class="language-python python">data<span class="token punctuation">[</span><span class="token string">'Time'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'Agent ID'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'Device Type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data<span class="token punctuation">[</span><span class="token string">'Accelerometer X'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'Accelerometer Y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'Accelerometer Z'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data<span class="token punctuation">[</span><span class="token string">'Gyroscope X'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'Gyroscope Y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'Gyroscope Z'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data<span class="token punctuation">[</span><span class="token string">'Longitude Degrees'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'Longitude Minutes'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data<span class="token punctuation">[</span><span class="token string">'Latitude Degrees'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'Latitude Minutes'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'Altitude'</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_all_data_for_user</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> minimum_entries<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-with">with</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">cursor <span class="token operator">=</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'SELECT * FROM user_data WHERE Agent_ID = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&lt;</span> minimum_entries<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token boolean">None</span>
</pre><p><em>or return an empty list</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> data
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_latest_data_for_user</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-with">with</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">cursor <span class="token operator">=</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'SELECT * FROM user_data WHERE Agent_ID = ? ORDER BY Time DESC LIMIT 1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> cursor<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_all_user_coordinates</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-with">with</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">cursor <span class="token operator">=</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'SELECT Time, Altitude, Latitude_Degrees, Longitude_Degrees FROM user_data WHERE Agent_ID = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_all_orentation_data_for_user</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-with">with</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">cursor <span class="token operator">=</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'SELECT Time,Acceleremoter_X,Acceleremoter_Y,Acceleremoter_Z,Gyroscope_X,Gyroscope_Y,Gyroscope_Z FROM user_data WHERE Agent_ID = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> data
</pre><p><em>Empty to allow this folder to be treated as a package and allow communication between files</em></p>
<h1 class="crossnote-header" id="__pycache__-4"><strong>pycache</strong></h1>

<h1 class="crossnote-header" id="heartrate_monitoring">HeartRate_Monitoring</h1>

<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> datetime <span class="token keyword keyword-import">import</span> datetime<span class="token punctuation">,</span> timedelta
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> scipy<span class="token punctuation">.</span>signal <span class="token keyword keyword-import">import</span> find_peaks
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> random
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">generate_ppg_data</span><span class="token punctuation">(</span>number_of_individuals<span class="token punctuation">,</span> sample_frequency<span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Generate synthetic PPG data for simulating both healthy and unhealthy individuals.  <strong>Parameter:</strong> number_of_individuals: int, the number of individual PPG data sets to create <strong>Parameter:</strong> sample_frequency: float, the sampling frequency in Hz <strong>Parameter:</strong> duration: float, the total duration in seconds for each individual's PPG data</p>
<p><em>Constants for mean heart rates of healthy and unhealthy conditions</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">healthy_mean_hr <span class="token operator">=</span> <span class="token number">75</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">unhealthy_mean_hr <span class="token operator">=</span> <span class="token number">90</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">noise_level <span class="token operator">=</span> <span class="token number">0.05</span>
</pre><p><em>Noise level for the generated signal</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> individual <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>number_of_individuals<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Randomly determine the start date and time for the simulation</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">start_datetime <span class="token operator">=</span> datetime<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span><span class="token number">2023</span><span class="token punctuation">)</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">59</span><span class="token punctuation">)</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">59</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p><em>Prepare the CSV data</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">csv_data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'DayOfWeek'</span><span class="token punctuation">,</span> <span class="token string">'Hour'</span><span class="token punctuation">,</span> <span class="token string">'Minute'</span><span class="token punctuation">,</span> <span class="token string">'Second'</span><span class="token punctuation">,</span> <span class="token string">'Condition'</span><span class="token punctuation">,</span> <span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">condition <span class="token operator">=</span> <span class="token string">'Healthy'</span> <span class="token keyword keyword-if">if</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.2</span> <span class="token keyword keyword-else">else</span> <span class="token string">'Unhealthy'</span>
</pre><p><em>Assign condition with 20% probability of being unhealthy</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">mean_heart_rate <span class="token operator">=</span> healthy_mean_hr <span class="token keyword keyword-if">if</span> condition <span class="token operator">==</span> <span class="token string">'Healthy'</span> <span class="token keyword keyword-else">else</span> unhealthy_mean_hr
</pre><p><em>Generate time intervals</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">time_intervals <span class="token operator">=</span> <span class="token punctuation">[</span>start_datetime <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span>t<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> t <span class="token keyword keyword-in">in</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> duration<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">/</span> sample_frequency<span class="token punctuation">)</span><span class="token punctuation">]</span>
</pre><p><em>Generate baseline and heartbeat signals</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">baseline_signal <span class="token operator">=</span> np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>pi <span class="token operator">*</span> mean_heart_rate <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> duration<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">/</span> sample_frequency<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">heartbeat_signal <span class="token operator">=</span> np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>pi <span class="token operator">*</span> mean_heart_rate <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> duration<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">/</span> sample_frequency<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">peaks<span class="token punctuation">,</span> _ <span class="token operator">=</span> find_peaks<span class="token punctuation">(</span>heartbeat_signal<span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">heartbeat_signal <span class="token operator">*=</span> <span class="token number">0</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">heartbeat_signal<span class="token punctuation">[</span>peaks<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
</pre><p><em>Combine signals and add noise</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">ppg_signal <span class="token operator">=</span> baseline_signal <span class="token operator">+</span> heartbeat_signal
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">ppg_signal <span class="token operator">+=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>normal<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> noise_level<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ppg_signal<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p><em>Append to CSV data with DateTime format</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> datetime_interval<span class="token punctuation">,</span> ppg <span class="token keyword keyword-in">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>time_intervals<span class="token punctuation">,</span> ppg_signal<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">day_of_week <span class="token operator">=</span> datetime_interval<span class="token punctuation">.</span>isoweekday<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Monday is 1, Sunday is 7</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">hour <span class="token operator">=</span> datetime_interval<span class="token punctuation">.</span>hour
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">minute <span class="token operator">=</span> datetime_interval<span class="token punctuation">.</span>minute
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">second <span class="token operator">=</span> datetime_interval<span class="token punctuation">.</span>second
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">csv_data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>day_of_week<span class="token punctuation">,</span> hour<span class="token punctuation">,</span> minute<span class="token punctuation">,</span> second<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> ppg<span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><p><em>Create a DataFrame</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>csv_data<span class="token punctuation">,</span> columns<span class="token operator">=</span>columns<span class="token punctuation">)</span>
</pre><p><em>Save to CSV file</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">file_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"E:\\Dev\\Deakin\\Project_Orion\\DataScience\\Models\\HeartRate Monitoring\\HRD\\individual_</span><span class="token interpolation"><span class="token punctuation">{</span>individual<span class="token punctuation">}</span></span><span class="token string">.csv"</span></span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</pre><p><em>Example usage to generate individual CSV files</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">generate_ppg_data<span class="token punctuation">(</span>number_of_individuals<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> sample_frequency<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> duration<span class="token operator">=</span><span class="token number">600</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> math
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> datetime
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword keyword-as">as</span> plt
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> os
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> panel <span class="token keyword keyword-as">as</span> pn
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> scipy<span class="token punctuation">.</span>fft <span class="token keyword keyword-import">import</span> fft
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> scipy<span class="token punctuation">.</span>stats <span class="token keyword keyword-import">import</span> skew<span class="token punctuation">,</span> kurtosis<span class="token punctuation">,</span> zscore
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword keyword-import">import</span> StandardScaler
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword keyword-import">import</span> train_test_split
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword keyword-import">import</span> LabelEncoder
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword keyword-import">import</span> LinearRegression
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword keyword-import">import</span> RandomForestRegressor
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword keyword-import">import</span> mean_squared_error
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>svm <span class="token keyword keyword-import">import</span> OneClassSVM
</pre><p>The HRMonitoring class is meant to manage the data input and output of the system. It is the main class that calls the other classes and functions.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-class">class</span> <span class="token class-name">HRmonitoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>userID<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>userID <span class="token operator">=</span> userID
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>features <span class="token operator">=</span> <span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'userID'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>userID
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">create_sequences</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> window_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">sequences <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> window_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">sequences<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>window_size<span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>sequences<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">extract_features</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Ensure data is present</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>data <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Data not loaded."</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span>
</pre><p><em>Baseline Heart Rate</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">baseline_hr <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><p><em>Heart Rate Variability (HRV)</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">rr_intervals <span class="token operator">=</span> np<span class="token punctuation">.</span>diff<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span>
</pre><p><em>Difference between successive heart rates</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">hrv <span class="token operator">=</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>rr_intervals<span class="token punctuation">)</span>
</pre><p><em>Outliers using IQR</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">Q1 <span class="token operator">=</span> np<span class="token punctuation">.</span>percentile<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Q3 <span class="token operator">=</span> np<span class="token punctuation">.</span>percentile<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">IQR <span class="token operator">=</span> Q3 <span class="token operator">-</span> Q1
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">outlier_count <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span>Q1 <span class="token operator">-</span> <span class="token number">1.5</span> <span class="token operator">*</span> IQR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span>Q3 <span class="token operator">+</span> <span class="token number">1.5</span> <span class="token operator">*</span> IQR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p><em>Frequency Domain Features using Fourier Transform</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">yf <span class="token operator">=</span> fft<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">power_spectrum <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>yf<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">dominant_frequency <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>power_spectrum<span class="token punctuation">)</span>
</pre><p><em>Moving Average (7-day window as an example)</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">moving_avg <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Skewness and Kurtosis</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">skewness <span class="token operator">=</span> skew<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">kurt <span class="token operator">=</span> kurtosis<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><p><em>Store features</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>features <span class="token operator">=</span> <span class="token punctuation">{</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">'baseline_hr'</span><span class="token punctuation">:</span> baseline_hr<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">'hrv'</span><span class="token punctuation">:</span> hrv<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">'outlier_count'</span><span class="token punctuation">:</span> outlier_count<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">'dominant_frequency'</span><span class="token punctuation">:</span> dominant_frequency<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">'moving_avg'</span><span class="token punctuation">:</span> moving_avg<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">'skewness'</span><span class="token punctuation">:</span> skewness<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token string">'kurtosis'</span><span class="token punctuation">:</span> kurt
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">detect_spikes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> window_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> threshold<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>data <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Data not loaded."</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span>
</pre><p><em>Calculate rolling mean and standard deviation</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">rolling_mean <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>window_size<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">rolling_std <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>window_size<span class="token punctuation">)</span><span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Detect spikes where the signal deviates from the rolling mean by more than the threshold times the rolling standard deviation</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">spikes <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span> <span class="token operator">-</span> rolling_mean<span class="token punctuation">)</span> <span class="token operator">&gt;</span> threshold <span class="token operator">*</span> rolling_std<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> spikes
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">detect_shifts</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> window_size<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> threshold<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>data <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Data not loaded."</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span>
</pre><p><em>Calculate rolling mean for two consecutive windows</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">rolling_mean_1 <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>window_size<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token operator">-</span>window_size<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">rolling_mean_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>window_size<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Detect shifts where the difference between the means of two consecutive windows is greater than the threshold</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">shifts <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>rolling_mean_1 <span class="token operator">-</span> rolling_mean_2<span class="token punctuation">)</span> <span class="token operator">&gt;</span> threshold<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> shifts
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Encoding the 'Condition' column</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">label_encoder <span class="token operator">=</span> LabelEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">[</span><span class="token string">'Condition_encoded'</span><span class="token punctuation">]</span> <span class="token operator">=</span> label_encoder<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'Condition'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><p><em>Drop the original 'Condition' column and use the encoded one</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">df <span class="token operator">=</span> df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Condition'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><p><em>Splitting the data into training and testing sets</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">X <span class="token operator">=</span> df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">y <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">X_train<span class="token punctuation">,</span> X_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_test <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">X_train<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> X_train<span class="token punctuation">,</span> X_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_test
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">train</span><span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> X_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_test<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Training Random Forest Regressor</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">rf_model <span class="token operator">=</span> RandomForestRegressor<span class="token punctuation">(</span>n_estimators<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">rf_model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
</pre><p><em>Predicting on the test set</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">rf_predictions <span class="token operator">=</span> rf_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span>
</pre><p><em>Evaluate the model using Mean Squared Error (MSE)</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">rf_mse <span class="token operator">=</span> mean_squared_error<span class="token punctuation">(</span>y_test<span class="token punctuation">,</span> rf_predictions<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> rf_model<span class="token punctuation">,</span> rf_mse
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> X_test<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Predicting on the test set</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">predictions <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> predictions
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">train_anomaly_detector</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sample_size<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Sample a subset of the data for training the One-Class SVM</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">subset_data <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>sample_size<span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>
</pre><p><em>Prepare features for the model</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">features <span class="token operator">=</span> subset_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</pre><p><em>Train the One-Class SVM</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>anomaly_model <span class="token operator">=</span> OneClassSVM<span class="token punctuation">(</span>nu<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> kernel<span class="token operator">=</span><span class="token string">"rbf"</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token string">"scale"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>anomaly_model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>features<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">detect_anomalies</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>anomaly_model <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Model not trained. Use the train_anomaly_detector method first."</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span>
</pre><p><em>Predict anomalies on the data</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">anomalies <span class="token operator">=</span> self<span class="token punctuation">.</span>anomaly_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><p><em>Filter out the anomaly rows</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">anomaly_data <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>anomalies <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> anomaly_data
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">path<span class="token operator">=</span><span class="token string">r'E:\Dev\Deakin\redbackoperations-T2_2023\Project 1 - Tracking Players and Crowd Monitoring\DataScience\Models\HeartRate_Monitoring\HRD'</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">monitor <span class="token operator">=</span> HRmonitoring<span class="token punctuation">(</span>userID<span class="token operator">=</span><span class="token string">"individual_0"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">monitor<span class="token punctuation">.</span>get_data<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"individual_0.csv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p><em>Extract features using the class methods</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">monitor<span class="token punctuation">.</span>extract_features<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Detect spikes and shifts</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">spikes <span class="token operator">=</span> monitor<span class="token punctuation">.</span>detect_spikes<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">shifts <span class="token operator">=</span> monitor<span class="token punctuation">.</span>detect_shifts<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Train the anomaly detector and detect anomalies</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">monitor<span class="token punctuation">.</span>train_anomaly_detector<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">anomalies <span class="token operator">=</span> monitor<span class="token punctuation">.</span>detect_anomalies<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Plot the results</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword keyword-as">as</span> plt
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"PPG Signal"</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>spikes<span class="token punctuation">,</span> monitor<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>spikes<span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Detected Spikes"</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"x"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>shifts<span class="token punctuation">,</span> monitor<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>shifts<span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'blue'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Detected Shifts"</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"o"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>anomalies<span class="token punctuation">.</span>index<span class="token punctuation">,</span> anomalies<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'green'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Detected Anomalies"</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"PPG Signal with Detected Spikes, Shifts, and Anomalies"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"Time (Samples)"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"PPG Signal Value"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">monitor<span class="token punctuation">.</span>extract_features<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Plotting the extracted features</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">fig<span class="token punctuation">,</span> axs <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p><em>PPG Signal with Moving Average and Outliers</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"PPG Signal"</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token string">'moving_avg'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Moving Average (7-sample window)"</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"purple"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Q1 <span class="token operator">=</span> np<span class="token punctuation">.</span>percentile<span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Q3 <span class="token operator">=</span> np<span class="token punctuation">.</span>percentile<span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">IQR <span class="token operator">=</span> Q3 <span class="token operator">-</span> Q1
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">outliers <span class="token operator">=</span> monitor<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span>Q1 <span class="token operator">-</span> <span class="token number">1.5</span> <span class="token operator">*</span> IQR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span>Q3 <span class="token operator">+</span> <span class="token number">1.5</span> <span class="token operator">*</span> IQR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>outliers<span class="token punctuation">.</span>index<span class="token punctuation">,</span> outliers<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"IQR Outliers"</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"x"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"PPG Signal with Moving Average and IQR Outliers"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">"Time (Samples)"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">"PPG Signal Value"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Frequency Domain Representation of PPG Signal</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">yf <span class="token operator">=</span> fft<span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'PPG_Signal'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">power_spectrum <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>yf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">(</span>yf<span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><p><em>Taking half due to symmetry</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">frequencies <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>power_spectrum<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p><em>Frequency values from 0 to Nyquist (0.5 for normalized freq.)</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>frequencies<span class="token punctuation">,</span> power_spectrum<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Frequency Spectrum"</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axvline<span class="token punctuation">(</span>frequencies<span class="token punctuation">[</span>monitor<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token string">'dominant_frequency'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Dominant Frequency"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"Frequency Domain Representation of PPG Signal"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">"Frequency (Normalized)"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">"Magnitude"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Displaying HRV</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"Heart Rate Variability (HRV): </span><span class="token interpolation"><span class="token punctuation">{</span>monitor<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token string">'hrv'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">horizontalalignment<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">,</span> verticalalignment<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>axs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transAxes<span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
</pre><p><em>Displaying Skewness and Kurtosis</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"Skewness: </span><span class="token interpolation"><span class="token punctuation">{</span>monitor<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token string">'skewness'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">horizontalalignment<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">,</span> verticalalignment<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>axs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transAxes<span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"Kurtosis: </span><span class="token interpolation"><span class="token punctuation">{</span>monitor<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token string">'kurtosis'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">horizontalalignment<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">,</span> verticalalignment<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>axs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transAxes<span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">axs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>close<span class="token punctuation">(</span>fig<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plot_panel <span class="token operator">=</span> pn<span class="token punctuation">.</span>pane<span class="token punctuation">.</span>Matplotlib<span class="token punctuation">(</span>fig<span class="token punctuation">,</span> tight<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><p><em>Empty to allow this folder to be treated as a package and allow communication between files</em></p>
<h1 class="crossnote-header" id="hrd">HRD</h1>

<h1 class="crossnote-header" id="__pycache__-5"><strong>pycache</strong></h1>

<h1 class="crossnote-header" id="individual_tracking">Individual_Tracking</h1>

<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> json
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword keyword-import">import</span> train_test_split
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> datetime <span class="token keyword keyword-import">import</span> datetime
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models <span class="token keyword keyword-import">import</span> Sequential
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers <span class="token keyword keyword-import">import</span> LSTM<span class="token punctuation">,</span> Bidirectional<span class="token punctuation">,</span> Dropout<span class="token punctuation">,</span> Dense<span class="token punctuation">,</span> Reshape<span class="token punctuation">,</span> Masking
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> tensorflow <span class="token keyword keyword-import">import</span> keras
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> keras<span class="token punctuation">.</span>callbacks <span class="token keyword keyword-import">import</span> EarlyStopping
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-class">class</span> <span class="token class-name">PredictiveTracking</span><span class="token punctuation">:</span>
</pre><p>A class for training and handling predictive tracking models for individual users.  Attributes: user_id (str): Unique identifier for the user. model_path (str): Path to the model file. seq_length (int): Length of the input sequence. pred_length (int): Length of the prediction sequence. last_trained_date (datetime): Timestamp of the last model training.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> preprocessed_data<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> seq_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> pred_length<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Initializes the PredictiveTracking class.  <strong>Parameter:</strong> user_id: Unique identifier for the user. <strong>Parameter:</strong> preprocessed_data: Preprocessed data for training or testing. <strong>Parameter:</strong> mode: Mode of operation, either 'train' or 'test'. <strong>Parameter:</strong> seq_length: Length of the input sequence, defaults to 20. <strong>Parameter:</strong> pred_length: Length of the prediction sequence, defaults to 10.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>user_id <span class="token operator">=</span> user_id
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model_path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Models/Individual Tracking &amp; Monitoring/IndiMods/model_</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">.h5"</span></span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>seq_length <span class="token operator">=</span> seq_length
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>pred_length <span class="token operator">=</span> pred_length
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> preprocessed_data <span class="token keyword keyword-is">is</span> <span class="token keyword keyword-not">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>load_data<span class="token punctuation">(</span>preprocessed_data<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">calculate_epochs</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> min_epochs<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> max_epochs<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Calculates the number of epochs based on the training samples.  <strong>Parameter:</strong> min_epochs: Minimum number of epochs, defaults to 20. <strong>Parameter:</strong> max_epochs: Maximum number of epochs, defaults to 250. <strong>Returns:</strong> Calculated number of epochs.</p>
<p><em>Get the number of training samples</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">num_samples <span class="token operator">=</span> self<span class="token punctuation">.</span>X_train<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</pre><p><em>Apply a sigmoid scaling factor</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">scaling_factor <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>num_samples <span class="token operator">-</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p><em>Reverse the scaling factor to get an inverse sigmoid</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">reverse_scaling_factor <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> scaling_factor
</pre><p><em>Scale the value to the desired range of epochs</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">epochs <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>min_epochs <span class="token operator">+</span> <span class="token punctuation">(</span>max_epochs <span class="token operator">-</span> min_epochs<span class="token punctuation">)</span> <span class="token operator">*</span> reverse_scaling_factor<span class="token punctuation">)</span>
</pre><p><em>Ensure the calculated epochs are within the defined bounds</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">epochs <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>min_epochs<span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>epochs<span class="token punctuation">,</span> max_epochs<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> epochs
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">load_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> preprocessed_data<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Loads the training and testing data.  <strong>Parameter:</strong> preprocessed_data: Preprocessed data for training or testing. <strong>Parameter:</strong> mode: Mode of operation, either 'train' or 'test', defaults to 'train'.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> mode <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>X_train<span class="token punctuation">,</span> self<span class="token punctuation">.</span>X_test<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_train<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_test <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span><span class="token operator">*</span>preprocessed_data<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>X_train<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> self<span class="token punctuation">.</span>X_test<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_train<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_test<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-elif">elif</span> mode <span class="token operator">==</span> <span class="token string">'test'</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>X_test<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_test <span class="token operator">=</span> preprocessed_data
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>X_test<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_test<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Invalid mode. Use 'train' or 'test'."</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">load_model</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Loads a pre-trained model from the file system.  <strong>Returns:</strong> Loaded model and the last trained date, or None if not found.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">model<span class="token operator">=</span>keras<span class="token punctuation">.</span>models<span class="token punctuation">.</span>load_model<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model_path<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-with">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model_path<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'h5'</span><span class="token punctuation">,</span><span class="token string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> read_file<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>read_file<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>last_trained_date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'last_trained_date'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%d-%m-%Y %H:%M:%S.%f"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> model<span class="token punctuation">,</span> self<span class="token punctuation">.</span>last_trained_date
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"No model found --{e}"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model <span class="token operator">=</span> <span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>last_trained_date <span class="token operator">=</span> <span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">train_model</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Trains the model using the loaded training data.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Masking<span class="token punctuation">(</span>mask_value<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span> input_shape<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>seq_length<span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p><em>Masking layer</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Bidirectional<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input_shape<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>seq_length<span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p><em>17 features</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Bidirectional<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Bidirectional<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Bidirectional<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Bidirectional<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Bidirectional<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Bidirectional<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pred_length <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Reshape<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pred_length<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p><em>Reshape to (pred_length, 2)</em></p>
<p><em>Compile with a custom learning rate</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">optimizer <span class="token operator">=</span> keras<span class="token punctuation">.</span>optimizers<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>optimizer<span class="token operator">=</span>optimizer<span class="token punctuation">,</span> loss<span class="token operator">=</span><span class="token string">'mse'</span><span class="token punctuation">)</span>
</pre><p><em>Calculate the number of epochs</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">epochs <span class="token operator">=</span> self<span class="token punctuation">.</span>calculate_epochs<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Implement early stopping</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">early_stopping <span class="token operator">=</span> EarlyStopping<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
</pre><p><em>Fit the model with validation split</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>X_train<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_train<span class="token punctuation">,</span> epochs<span class="token operator">=</span>epochs<span class="token punctuation">,</span> validation_split<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> callbacks<span class="token operator">=</span><span class="token punctuation">[</span>early_stopping<span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>last_trained_date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">save_model</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Saves the trained model to the file system and logs the training date.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>save<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model_path<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Model saved"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data<span class="token operator">=</span> self<span class="token punctuation">.</span>last_trained_date<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%d/%m/%Y %H:%M:%S"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-with">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model_path<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'h5'</span><span class="token punctuation">,</span><span class="token string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> write_file<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>data<span class="token punctuation">,</span> write_file<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Model logged"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>cluster <span class="token keyword keyword-import">import</span> DBSCAN
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword keyword-import">import</span> IsolationForest
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> geopy <span class="token keyword keyword-import">import</span> distance
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> geopy<span class="token punctuation">.</span>distance <span class="token keyword keyword-import">import</span> geodesic
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> geopy<span class="token punctuation">.</span>distance <span class="token keyword keyword-import">import</span> great_circle
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> glob
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> os
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> datetime <span class="token keyword keyword-import">import</span> datetime<span class="token punctuation">,</span>timedelta
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models <span class="token keyword keyword-import">import</span> load_model
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> PMT_run <span class="token keyword keyword-import">import</span> PredictiveTracking
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>sequence <span class="token keyword keyword-import">import</span> pad_sequences
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword keyword-import">import</span> mean_squared_error<span class="token punctuation">,</span>mean_absolute_error
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword keyword-as">as</span> plt
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> sys
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> panel <span class="token keyword keyword-as">as</span> pn
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">r'e:\\Dev\\Deakin\\redbackoperations-T2_2023\\Project 1 - Tracking Players and Crowd Monitoring\\DataScience\\Models'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">broker_address<span class="token operator">=</span><span class="token string">"test.mosquitto.org"</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">topic<span class="token operator">=</span><span class="token string">"Orion_test/Individual Tracking &amp; Monitoring"</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">topic<span class="token operator">=</span><span class="token string">"Orion_test/UTP"</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> DataManager<span class="token punctuation">.</span>MQTTManager <span class="token keyword keyword-import">import</span> MQTTDataFrameHandler <span class="token keyword keyword-as">as</span> MQDH
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Handler<span class="token operator">=</span>MQDH<span class="token punctuation">(</span>broker_address<span class="token punctuation">,</span> topic<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Reciever<span class="token operator">=</span>MQDH<span class="token punctuation">(</span>broker_address<span class="token punctuation">,</span> <span class="token string">"Orion_test/UTP"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-class">class</span> <span class="token class-name">RealTimeTracking</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Initializes the RealTimeTracking class with user_id. <strong>Parameter:</strong> user_id: Unique identifier for the user</p>
<pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>user_id <span class="token operator">=</span> user_id
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>seq_length <span class="token operator">=</span> <span class="token number">20</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>train_date<span class="token operator">=</span><span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model_path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"E:/Dev/Deakin/redbackoperations-T2_2023/Project 1 - Tracking Players and Crowd Monitoring/DataScience/IndividualLSTMs/model_</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">.h5"</span></span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>predictive_model<span class="token operator">=</span><span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_trajectory</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> gps_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Filters the GPS data to return only the trajectory for the given user. <strong>Parameter:</strong> gps_data: DataFrame containing GPS data <strong>Returns:</strong> DataFrame containing the trajectory for the user</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> gps_data<span class="token punctuation">[</span>gps_data<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>user_id<span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_direction</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> point1<span class="token punctuation">,</span> point2<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Calculates the direction from point1 to point2. <strong>Parameter:</strong> point1: Dictionary containing the 'Latitude' and 'Longitude' of the first point <strong>Parameter:</strong> point2: Dictionary containing the 'Latitude' and 'Longitude' of the second point <strong>Returns:</strong> Direction angle in radians</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> np<span class="token punctuation">.</span>arctan2<span class="token punctuation">(</span>point2<span class="token punctuation">[</span><span class="token string">'Longitude'</span><span class="token punctuation">]</span> <span class="token operator">-</span> point1<span class="token punctuation">[</span><span class="token string">'Longitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> point2<span class="token punctuation">[</span><span class="token string">'Latitude'</span><span class="token punctuation">]</span> <span class="token operator">-</span> point1<span class="token punctuation">[</span><span class="token string">'Latitude'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_distance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> point1<span class="token punctuation">,</span> point2<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Calculates the distance between two geographical points. <strong>Parameter:</strong> point1: Dictionary containing the 'Latitude' and 'Longitude' of the first point <strong>Parameter:</strong> point2: Dictionary containing the 'Latitude' and 'Longitude' of the second point <strong>Returns:</strong> Distance in meters</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> distance<span class="token punctuation">.</span>distance<span class="token punctuation">(</span><span class="token punctuation">(</span>point1<span class="token punctuation">[</span><span class="token string">'Latitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>point1<span class="token punctuation">[</span><span class="token string">'Longitude'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>point2<span class="token punctuation">[</span><span class="token string">'Latitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>point2<span class="token punctuation">[</span><span class="token string">'Longitude'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>meters
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_speed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> initialpoint<span class="token punctuation">,</span>finalpoint<span class="token punctuation">,</span>initialtime<span class="token punctuation">,</span>finaltime<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Calculates the speed between two points given the time taken to travel. <strong>Parameter:</strong> initialpoint: Starting point as a dictionary with 'Latitude' and 'Longitude' <strong>Parameter:</strong> finalpoint: Ending point as a dictionary with 'Latitude' and 'Longitude' <strong>Parameter:</strong> initialtime: Start time as a datetime object <strong>Parameter:</strong> finaltime: End time as a datetime object <strong>Returns:</strong> Speed in meters per second</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>get_distance<span class="token punctuation">(</span>initialpoint<span class="token punctuation">,</span>finalpoint<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>finaltime <span class="token operator">-</span> initialtime<span class="token punctuation">)</span><span class="token punctuation">.</span>seconds
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_acceleration</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> initialspeed<span class="token punctuation">,</span>finalspeed<span class="token punctuation">,</span>initialtime<span class="token punctuation">,</span>finaltime<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Calculates the acceleration given the initial and final speeds and the time taken. <strong>Parameter:</strong> initialspeed: Initial speed in meters per second <strong>Parameter:</strong> finalspeed: Final speed in meters per second <strong>Parameter:</strong> initialtime: Start time as a datetime object <strong>Parameter:</strong> finaltime: End time as a datetime object <strong>Returns:</strong> Acceleration in meters per second squared</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span>finalspeed <span class="token operator">-</span> initialspeed<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>finaltime <span class="token operator">-</span> initialtime<span class="token punctuation">)</span><span class="token punctuation">.</span>seconds
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_stops</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trajectory<span class="token punctuation">,</span> time_threshold<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">stops <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>trajectory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>get_distance<span class="token punctuation">(</span>trajectory<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trajectory<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword keyword-and">and</span> \
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">(</span>trajectory<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'Datetime'</span><span class="token punctuation">]</span> <span class="token operator">-</span> trajectory<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'Datetime'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>seconds <span class="token operator">&gt;=</span> time_threshold<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">stops<span class="token punctuation">.</span>append<span class="token punctuation">(</span>trajectory<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> stops
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_mode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> speeds<span class="token punctuation">,</span> accelerations<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">avg_speed <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>speeds<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">avg_acceleration <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>accelerations<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> avg_speed <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token string">'walking'</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-elif">elif</span> avg_speed <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token string">'cycling'</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> <span class="token string">'driving'</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_frequent_areas</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trajectory<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> min_samples<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">coords <span class="token operator">=</span> <span class="token punctuation">[</span>point<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Latitude'</span><span class="token punctuation">,</span> <span class="token string">'Longitude'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> _<span class="token punctuation">,</span> point <span class="token keyword keyword-in">in</span> trajectory<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">clustering <span class="token operator">=</span> DBSCAN<span class="token punctuation">(</span>eps<span class="token operator">=</span>eps<span class="token punctuation">,</span> min_samples<span class="token operator">=</span>min_samples<span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>coords<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">clusters <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> label <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>clustering<span class="token punctuation">.</span>labels_<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> label <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> label <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> clusters<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">clusters<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">clusters<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>trajectory<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> clusters
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_anomalies</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trajectory<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">coords <span class="token operator">=</span> <span class="token punctuation">[</span>point<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Latitude'</span><span class="token punctuation">,</span> <span class="token string">'Longitude'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> _<span class="token punctuation">,</span> point <span class="token keyword keyword-in">in</span> trajectory<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">model <span class="token operator">=</span> IsolationForest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>coords<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">anomalies <span class="token operator">=</span> <span class="token punctuation">[</span>point <span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> point <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>trajectory<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">[</span>coords<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> anomalies
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_time_feature</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> cluster<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'Datetime'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>hour
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">create_prediction_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trajectory<span class="token punctuation">,</span> common_areas<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Process the data similarly to the preprocess_data method</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">X<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>preprocess_data<span class="token punctuation">(</span>trajectory<span class="token punctuation">,</span> common_areas<span class="token punctuation">)</span>
</pre><p><em>Select one sequence</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">pred_sequence <span class="token operator">=</span> X<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</pre><p><em>Replace the first four features with placeholder values (e.g., zeros)</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">pred_sequence<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
</pre><p><em>Reshape to match the expected input shape</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">pred_sequence <span class="token operator">=</span> pred_sequence<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> pred_sequence<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred_sequence<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> pred_sequence
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">get_ground_truth</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trajectory<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Preprocess the data to get the original features, including the coordinates</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">_<span class="token punctuation">,</span> y <span class="token operator">=</span> self<span class="token punctuation">.</span>preprocess_data<span class="token punctuation">(</span>trajectory<span class="token punctuation">)</span>
</pre><p><em>Select the corresponding ground truth for the first sequence</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">ground_truth <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> ground_truth
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">test_prediction</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trajectory<span class="token punctuation">,</span> common_areas<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Create test data for the given trajectory</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">test_sequence <span class="token operator">=</span> self<span class="token punctuation">.</span>create_prediction_data<span class="token punctuation">(</span>trajectory<span class="token punctuation">,</span> common_areas<span class="token punctuation">)</span>
</pre><p><em>Load the trained model</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model <span class="token operator">=</span> load_model<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model_path<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-except">except</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"No model found. Please train the model first."</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span>
</pre><p><em>Make a prediction using the test sequence</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">prediction <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_sequence<span class="token punctuation">)</span>
</pre><p><em>Retrieve the ground truth (actual future coordinates) for the test sequence</em></p>
<p><em>Assuming you have a method to obtain the ground truth</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">ground_truth <span class="token operator">=</span> self<span class="token punctuation">.</span>get_ground_truth<span class="token punctuation">(</span>trajectory<span class="token punctuation">)</span>
</pre><p><em>Compute metrics</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">mae <span class="token operator">=</span> mean_absolute_error<span class="token punctuation">(</span>ground_truth<span class="token punctuation">,</span> prediction<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">mse <span class="token operator">=</span> mean_squared_error<span class="token punctuation">(</span>ground_truth<span class="token punctuation">,</span> prediction<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><p><em>Print the prediction results</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Predicted coordinates:"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> coords <span class="token keyword keyword-in">in</span> prediction<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Latitude: </span><span class="token interpolation"><span class="token punctuation">{</span>coords<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">, Longitude: </span><span class="token interpolation"><span class="token punctuation">{</span>coords<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</pre><p><em>Print the metrics</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Mean Absolute Error: </span><span class="token interpolation"><span class="token punctuation">{</span>mae<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Mean Squared Error: </span><span class="token interpolation"><span class="token punctuation">{</span>mse<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">preprocess_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trajectory<span class="token punctuation">,</span> common_areas<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">frequent_areas <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>get_frequent_areas<span class="token punctuation">(</span>trajectory<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">combined_areas <span class="token operator">=</span> <span class="token punctuation">[</span>area<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> area <span class="token keyword keyword-in">in</span> frequent_areas<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</pre><p><em>Take the first 10 frequent areas</em></p>
<p><em>If there are fewer than 10 frequent areas, add common areas</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-while">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>combined_areas<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> common_areas <span class="token keyword keyword-is">is</span> <span class="token keyword keyword-not">not</span> <span class="token boolean">None</span> <span class="token keyword keyword-and">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>common_areas<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">combined_areas<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'Latitude'</span><span class="token punctuation">:</span> common_areas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'Longitude'</span><span class="token punctuation">:</span> common_areas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">common_areas<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">combined_areas<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'Latitude'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Longitude'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><p><em>Fill with zeros if not enough areas</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">features <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> point <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>trajectory<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token string">'records'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>Add the coordinates to the feature list along with other features</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">feature_vector <span class="token operator">=</span> <span class="token punctuation">[</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">point<span class="token punctuation">[</span><span class="token string">'Latitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">point<span class="token punctuation">[</span><span class="token string">'Longitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>get_speed<span class="token punctuation">(</span>point<span class="token punctuation">,</span> trajectory<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> point<span class="token punctuation">[</span><span class="token string">'Datetime'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trajectory<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'Datetime'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>get_direction<span class="token punctuation">(</span>point<span class="token punctuation">,</span> trajectory<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><p><em>Direction</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">point<span class="token punctuation">[</span><span class="token string">'Datetime'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weekday<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">point<span class="token punctuation">[</span><span class="token string">'Datetime'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>hour<span class="token punctuation">,</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">point<span class="token punctuation">[</span><span class="token string">'Datetime'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>minute
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>area<span class="token punctuation">[</span><span class="token string">'Latitude'</span><span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> area <span class="token keyword keyword-in">in</span> combined_areas<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>area<span class="token punctuation">[</span><span class="token string">'Longitude'</span><span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> area <span class="token keyword keyword-in">in</span> combined_areas<span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">features<span class="token punctuation">.</span>append<span class="token punctuation">(</span>feature_vector<span class="token punctuation">)</span>
</pre><p><em>Create sequences and future coordinates</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">sequences <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">future_coordinates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>features<span class="token punctuation">)</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>seq_length <span class="token operator">-</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p><em>9 is to accommodate 10 future coordinates</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">sequence <span class="token operator">=</span> features<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>self<span class="token punctuation">.</span>seq_length<span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">future_coord <span class="token operator">=</span> <span class="token punctuation">[</span>features<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> j <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i<span class="token operator">+</span>self<span class="token punctuation">.</span>seq_length<span class="token punctuation">,</span> i<span class="token operator">+</span>self<span class="token punctuation">.</span>seq_length<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</pre><p><em>Take only Latitude and Longitude</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">sequences<span class="token punctuation">.</span>append<span class="token punctuation">(</span>sequence<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">future_coordinates<span class="token punctuation">.</span>append<span class="token punctuation">(</span>future_coord<span class="token punctuation">)</span>
</pre><p><em>Convert to NumPy arrays</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">X <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>sequences<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">y <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>future_coordinates<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> X<span class="token punctuation">,</span> y
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">generate_future_coordinates</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trajectory<span class="token punctuation">,</span> common_areas<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> number_of_future_points<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> time_interval_minutes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>trajectory<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p><em>Get the latest data point from the trajectory</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">latest_data_point <span class="token operator">=</span> trajectory<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
</pre><p><em>Create a list of future datetimes</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">future_datetimes <span class="token operator">=</span> <span class="token punctuation">[</span>latest_data_point<span class="token punctuation">[</span><span class="token string">'Datetime'</span><span class="token punctuation">]</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span>i <span class="token operator">*</span> time_interval_minutes<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> number_of_future_points <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</pre><p><em>Create a DataFrame to hold the future trajectory</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">future_trajectory <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>columns<span class="token operator">=</span>trajectory<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>
</pre><p><em>Populate the future trajectory DataFrame with the latest data point and future datetimes</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> future_datetime <span class="token keyword keyword-in">in</span> future_datetimes<span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">future_data_point <span class="token operator">=</span> latest_data_point<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">future_data_point<span class="token punctuation">[</span><span class="token string">'Datetime'</span><span class="token punctuation">]</span> <span class="token operator">=</span> future_datetime
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">future_trajectory <span class="token operator">=</span> future_trajectory<span class="token punctuation">.</span>append<span class="token punctuation">(</span>future_data_point<span class="token punctuation">,</span> ignore_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>future_trajectory<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p><em>Create test data for the given trajectory and future datetimes</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">pred_sequence <span class="token operator">=</span> self<span class="token punctuation">.</span>create_prediction_data<span class="token punctuation">(</span>future_trajectory<span class="token punctuation">,</span> common_areas<span class="token punctuation">)</span>
</pre><p><em>Load the trained model</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>model <span class="token operator">=</span> load_model<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model_path<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-except">except</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"No model found. Please train the model first."</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span>
</pre><p><em>Make a prediction using the test sequence</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">prediction <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>pred_sequence<span class="token punctuation">)</span>
</pre><p><em>Convert the prediction to a list of coordinates (latitude, longitude)</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">predicted_coordinates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>coords<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> coords<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> coords <span class="token keyword keyword-in">in</span> prediction<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> predicted_coordinates
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">train_personalised_model</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trajectory_data<span class="token punctuation">,</span> retrain<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">preprocessed_data <span class="token operator">=</span> self<span class="token punctuation">.</span>preprocess_data<span class="token punctuation">(</span>trajectory_data<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">model<span class="token operator">=</span>load_model<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model_path<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-except">except</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">model<span class="token operator">=</span><span class="token boolean">None</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> retrain <span class="token keyword keyword-and">and</span> model <span class="token keyword keyword-is">is</span> <span class="token keyword keyword-not">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Retraining model......"</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>predictive_model <span class="token operator">=</span> PredictiveTracking<span class="token punctuation">(</span>self<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> preprocessed_data<span class="token punctuation">,</span><span class="token string">'train'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>predictive_model<span class="token punctuation">.</span>train_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>predictive_model<span class="token punctuation">.</span>save_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-elif">elif</span> <span class="token keyword keyword-not">not</span> retrain <span class="token keyword keyword-and">and</span> model <span class="token keyword keyword-is">is</span> <span class="token keyword keyword-not">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Model already trained. Use retrain=True to retrain the model."</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-elif">elif</span> model <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"No model found. Training new model..."</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>predictive_model <span class="token operator">=</span> PredictiveTracking<span class="token punctuation">(</span>self<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> preprocessed_data<span class="token punctuation">,</span><span class="token string">'train'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>predictive_model<span class="token punctuation">.</span>train_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">self<span class="token punctuation">.</span>predictive_model<span class="token punctuation">.</span>save_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span>
</pre><p><em>this should only be used during testing --some modifications needed to use it in production</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">read_plt</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Reads a plt file and returns it as a DataFrame, adding a user_id column. <strong>Parameter:</strong> file_path: Path to the plt file <strong>Parameter:</strong> user_id: Unique identifier for the user <strong>Returns:</strong> DataFrame containing the plt file data with added user_id</p>
<pre data-role="codeBlock" data-info="python" class="language-python python">columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Latitude'</span><span class="token punctuation">,</span> <span class="token string">'Longitude'</span><span class="token punctuation">,</span> <span class="token string">'Reserved'</span><span class="token punctuation">,</span> <span class="token string">'Altitude'</span><span class="token punctuation">,</span> <span class="token string">'NumDays'</span><span class="token punctuation">,</span> <span class="token string">'Date'</span><span class="token punctuation">,</span> <span class="token string">'Time'</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> skiprows<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> names<span class="token operator">=</span>columns<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data<span class="token punctuation">[</span><span class="token string">'Altitude'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'Altitude'</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.3048</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data<span class="token punctuation">[</span><span class="token string">'Datetime'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> data<span class="token punctuation">[</span><span class="token string">'Time'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">,</span> <span class="token string">'Time'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">data<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_id
</pre><p><em>Add user_id to the DataFrame</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span> data
</pre><p><em>common_areas = [(lat1, lon1), (lat2, lon2), ...]</em></p>
<p><em>Example common areas i.e. landmarks,coffee shops</em></p>
<p><em>Empty to allow this folder to be treated as a package and allow communication between files</em></p>
<h1 class="crossnote-header" id="__pycache__-6"><strong>pycache</strong></h1>

<h1 class="crossnote-header" id="overcrowding_detection">Overcrowding_Detection</h1>

<pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword keyword-as">as</span> plt
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> matplotlib<span class="token punctuation">.</span>cm <span class="token keyword keyword-as">as</span> cm
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>cluster <span class="token keyword keyword-import">import</span> DBSCAN
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> seaborn <span class="token keyword keyword-as">as</span> sns
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> folium
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> folium<span class="token punctuation">.</span>plugins <span class="token keyword keyword-import">import</span> HeatMap
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> panel <span class="token keyword keyword-as">as</span> pn
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-import">import</span> sys
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">r'e:\\Dev\\Deakin\\redbackoperations-T2_2023\\Project 1 - Tracking Players and Crowd Monitoring\\DataScience\\Models'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">broker_address<span class="token operator">=</span><span class="token string">"test.mosquitto.org"</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">topic<span class="token operator">=</span><span class="token string">"Orion_test/Overcrowding Detection"</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-from">from</span> DataManager<span class="token punctuation">.</span>MQTTManager <span class="token keyword keyword-import">import</span> MQTTDataFrameHandler <span class="token keyword keyword-as">as</span> MQDH
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">Handler<span class="token operator">=</span>MQDH<span class="token punctuation">(</span>broker_address<span class="token punctuation">,</span> topic<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-def">def</span> <span class="token function">process_data</span><span class="token punctuation">(</span>gps_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><p>Processes the GPS data using DBSCAN clustering and plots the clusters.  <strong>Parameter:</strong> gps_data: A numpy array with GPS coordinates in the format [[latitude1, longitude1], [latitude2, longitude2], ...].</p>
<p><em>Using DBSCAN to cluster the data</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">dbscan <span class="token operator">=</span> DBSCAN<span class="token punctuation">(</span>eps<span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">,</span> min_samples<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span> metric<span class="token operator">=</span><span class="token string">'euclidean'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">clusters <span class="token operator">=</span> dbscan<span class="token punctuation">.</span>fit_predict<span class="token punctuation">(</span>gps_data<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'Latitude'</span><span class="token punctuation">:</span> gps_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'Longitude'</span><span class="token punctuation">:</span> gps_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'Cluster'</span><span class="token punctuation">:</span> clusters<span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">num_clusters <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>clusters<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword keyword-if">if</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword keyword-in">in</span> clusters <span class="token keyword keyword-else">else</span> <span class="token number">0</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">colors <span class="token operator">=</span> cm<span class="token punctuation">.</span>rainbow<span class="token punctuation">(</span>np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> num_clusters<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">figure<span class="token operator">=</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-for">for</span> cluster_id<span class="token punctuation">,</span> color <span class="token keyword keyword-in">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>clusters<span class="token punctuation">)</span><span class="token punctuation">,</span> colors<span class="token punctuation">)</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-if">if</span> cluster_id <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-continue">continue</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">cluster_points <span class="token operator">=</span> df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'Cluster'</span><span class="token punctuation">]</span> <span class="token operator">==</span> cluster_id<span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>cluster_points<span class="token punctuation">[</span><span class="token string">'Longitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cluster_points<span class="token punctuation">[</span><span class="token string">'Latitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token punctuation">[</span>color<span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f'Cluster </span><span class="token interpolation"><span class="token punctuation">{</span>cluster_id<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Clusters of Points'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Longitude'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Latitude'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python"><span class="token keyword keyword-return">return</span>  df<span class="token punctuation">,</span>figure
</pre><p><em>Initialize empty arrays for latitudes and longitudes</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">latitudes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">longitudes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><p><em>reading latitudes and longitudes from the VirtualCrowd_Test_Cleaned.csv</em></p>
<p><em>change this line depending on the file path</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">r'E:\Dev\Deakin\redbackoperations-T2_2023\Project 1 - Tracking Players and Crowd Monitoring\DataScience\Clean Datasets\VD4.csv'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">selected_time_data <span class="token operator">=</span> df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">"Time"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'22:22:01'</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">time <span class="token operator">=</span> df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">"Time"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'23:39:33'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">latitudes_list <span class="token operator">=</span> time<span class="token punctuation">[</span><span class="token string">" Longitude Degrees"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">longitudes_list <span class="token operator">=</span> time<span class="token punctuation">[</span><span class="token string">" Latitude Degrees"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>remove "Time" to facilitate the processing</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token string">"Time"</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">latitudes <span class="token operator">=</span> latitudes_list
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">longitudes <span class="token operator">=</span> longitudes_list
</pre><p><em>Processing the data and plotting</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">gps_data <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>latitudes<span class="token punctuation">,</span> longitudes<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">cluster_data<span class="token punctuation">,</span>fig1<span class="token operator">=</span>process_data<span class="token punctuation">(</span>gps_data<span class="token punctuation">)</span>
</pre><p><em>Creating a DataFrame with the latitude and longitude data</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">heatmap_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'Latitude'</span><span class="token punctuation">:</span> latitudes<span class="token punctuation">,</span> <span class="token string">'Longitude'</span><span class="token punctuation">:</span> longitudes<span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><p><em>Plotting the heatmap using Seaborn's kdeplot function</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">figure2<span class="token operator">=</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">sns<span class="token punctuation">.</span>kdeplot<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token string">'Longitude'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Latitude'</span><span class="token punctuation">,</span> data<span class="token operator">=</span>heatmap_data<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'Reds'</span><span class="token punctuation">,</span> fill<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Heatmap of Points'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Longitude'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Latitude'</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Calculate the mean latitude and longitude for centering the map</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">mean_latitude <span class="token operator">=</span> selected_time_data<span class="token punctuation">[</span><span class="token string">" Latitude Degrees"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">mean_longitude <span class="token operator">=</span> selected_time_data<span class="token punctuation">[</span><span class="token string">" Longitude Degrees"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p><em>Create a base map, centered at the mean coordinates</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">base_map <span class="token operator">=</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token punctuation">[</span>mean_latitude<span class="token punctuation">,</span> mean_longitude<span class="token punctuation">]</span><span class="token punctuation">,</span> zoom_start<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">)</span>
</pre><p><em>Create a list of [lat, lon] pairs for the heatmap</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">heatmap_data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>lat<span class="token punctuation">,</span> lon<span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> lat<span class="token punctuation">,</span> lon <span class="token keyword keyword-in">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>selected_time_data<span class="token punctuation">[</span><span class="token string">" Latitude Degrees"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> selected_time_data<span class="token punctuation">[</span><span class="token string">" Longitude Degrees"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</pre><p><em>Add the heatmap layer to the base map with adjusted parameters</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">HeatMap<span class="token punctuation">(</span>heatmap_data<span class="token punctuation">,</span> radius<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span> max_zoom<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">,</span> blur<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_to<span class="token punctuation">(</span>base_map<span class="token punctuation">)</span>
</pre><p><em>Save the map to an HTML file (optional)</em></p>
<p><em>change this line depending on the file path</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">base_map<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">r'E:\Dev\Deakin\redbackoperations-T2_2023\Project 1 - Tracking Players and Crowd Monitoring\DataScience\Models\Overcrowding_Detection\heatmap.html'</span><span class="token punctuation">)</span>
</pre><p><em>Handler.send_data(cluster_data)#send the data to the broker</em></p>
<p><em>plt.close(fig1)</em></p>
<p><em>plt.close(figure2)</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python">plot_panel <span class="token operator">=</span> pn<span class="token punctuation">.</span>pane<span class="token punctuation">.</span>Matplotlib<span class="token punctuation">(</span>fig1<span class="token punctuation">,</span> tight<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python python">plot_panel2 <span class="token operator">=</span> pn<span class="token punctuation">.</span>pane<span class="token punctuation">.</span>Matplotlib<span class="token punctuation">(</span>figure2<span class="token punctuation">,</span> tight<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</pre><p><em>Empty to allow this folder to be treated as a package and allow communication between files</em></p>
<h1 class="crossnote-header" id="__pycache__-7"><strong>pycache</strong></h1>

<h1 class="crossnote-header" id="variables">variables</h1>


      </div>
      
      
    
    
    
    
    
    
  
    </body></html>